# 实施计划: 服务分类重构

## 概述

本实施计划将服务分类从多级树形结构简化为扁平化结构。重构分为4个阶段：代码重构、数据库迁移、前端优化和文档更新。每个阶段都包含具体的实施任务和测试任务。

## 任务

- [x] 1. 阶段1: 代码重构 - 简化业务逻辑层
  - 简化 CategoryLogic 类，移除树形结构处理逻辑
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 1.1 简化 CategoryLogic::add() 方法
  - 移除 pid 参数处理
  - 移除层级计算逻辑
  - 移除父级分类检查逻辑
  - 简化同名检查（不再检查同级，改为全局检查）
  - 移除 level 字段的设置
  - _需求: 3.2, 3.3, 3.7, 5.3_

- [ ]* 1.2 为 CategoryLogic::add() 编写属性测试
  - **属性 3: 分类名称唯一性**
  - **属性 4: CRUD操作幂等性**
  - **验证需求: 3.7, 5.3**

- [x] 1.3 简化 CategoryLogic::edit() 方法
  - 移除 pid 参数处理
  - 移除层级计算逻辑
  - 移除父子关系检查逻辑
  - 移除"不能将分类设置为自己的子分类"检查
  - 移除"不能将分类移动到其子分类下"检查
  - 简化同名检查
  - 移除 level 字段的更新
  - _需求: 3.4, 3.5, 3.7, 5.4_

- [ ]* 1.4 为 CategoryLogic::edit() 编写属性测试
  - **属性 3: 分类名称唯一性**
  - **属性 4: CRUD操作幂等性**
  - **验证需求: 3.7, 5.4**

- [x] 1.5 简化 CategoryLogic::delete() 方法
  - 移除子分类检查逻辑
  - 保留工作人员关联检查
  - _需求: 3.6, 3.7, 5.5_

- [ ]* 1.6 为 CategoryLogic::delete() 编写属性测试
  - **属性 4: CRUD操作幂等性**
  - **属性 5: 删除前置条件**
  - **验证需求: 3.7, 5.5**

- [x] 1.7 简化 CategoryLogic::getAll() 方法
  - 移除 buildTree() 调用
  - 直接返回扁平列表
  - 移除 pid 和 level 字段的查询
  - _需求: 3.1, 5.1_

- [ ]* 1.8 为 CategoryLogic::getAll() 编写属性测试
  - **属性 1: 扁平列表结构**
  - **验证需求: 3.1, 5.1**

- [x] 1.9 简化 CategoryLogic::tree() 方法
  - 移除 buildTree() 调用
  - 返回扁平列表（保持向后兼容）
  - 移除 pid 字段的查询
  - _需求: 2.4, 5.1_

- [ ]* 1.10 为 CategoryLogic::tree() 编写属性测试
  - **属性 1: 扁平列表结构**
  - **验证需求: 2.4, 5.1**

- [x] 1.11 简化 CategoryLogic::detail() 方法
  - 移除 parent 关联的预加载
  - 直接查询分类信息
  - _需求: 2.1, 5.2_

- [ ]* 1.12 为 CategoryLogic::detail() 编写属性测试
  - **属性 2: 分类详情完整性**
  - **验证需求: 5.2**

- [x] 1.13 移除 CategoryLogic 中的辅助方法
  - 移除 buildTree() 方法
  - 移除 getChildIds() 方法
  - _需求: 3.1_

- [x] 2. 阶段1: 代码重构 - 简化模型层
  - 简化 ServiceCategory 模型，移除树形结构相关方法
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 2.1 移除 ServiceCategory 模型中的关联方法
  - 移除 parent() 方法
  - 移除 children() 方法
  - 保留 staffs() 和 packages() 关联
  - _需求: 2.1, 2.2_

- [x] 2.2 移除 ServiceCategory 模型中的树形构建方法
  - 移除 buildTree() 静态方法
  - 移除 getCategoryTree() 静态方法
  - _需求: 2.3_

- [x] 2.3 添加 ServiceCategory::getCategoryList() 方法
  - 创建新的静态方法返回扁平列表
  - 查询所有显示的分类
  - 按 sort 和 id 排序
  - _需求: 2.4_

- [ ]* 2.4 为 ServiceCategory::getCategoryList() 编写属性测试
  - **属性 1: 扁平列表结构**
  - **验证需求: 2.4**

- [x] 3. 阶段1: 代码重构 - 简化验证器层
  - 简化 CategoryValidate 验证器，移除冗余字段验证
  - _需求: 4.1, 4.2, 4.3_

- [x] 3.1 简化 CategoryValidate 验证规则
  - 移除 pid 字段验证规则
  - 移除 pid 相关的错误提示
  - 添加 image 字段验证规则
  - _需求: 4.1_

- [x] 3.2 简化 CategoryValidate 验证场景
  - 从 add 场景移除 pid
  - 从 edit 场景移除 pid
  - 在 add 和 edit 场景添加 image
  - _需求: 4.1_

- [x] 3.3 移除 CategoryValidate 验证方法
  - 移除 checkParent() 方法
  - 保留 checkCategory() 方法
  - _需求: 4.2_

- [ ]* 3.4 为 CategoryValidate 编写属性测试
  - **属性 6: 表单验证正确性**
  - **验证需求: 4.3**

- [x] 4. 检查点 - 代码重构完成
  - 确保所有测试通过，询问用户是否有问题

- [x] 5. 阶段2: 数据库迁移 - 创建迁移脚本
  - 创建数据库迁移和回滚脚本
  - _需求: 1.1, 1.2, 1.3, 7.2_

- [x] 5.1 创建数据库迁移脚本
  - 创建 server/sql/wedding/017_simplify_service_category.sql
  - 添加移除 level 字段的 SQL
  - 添加移除 pid 字段的 SQL
  - 添加移除索引的 SQL
  - _需求: 1.1, 1.2, 1.3_

- [x] 5.2 创建数据库回滚脚本
  - 创建 server/sql/wedding/017_rollback_simplify_service_category.sql
  - 添加恢复 pid 字段的 SQL
  - 添加恢复 level 字段的 SQL
  - 添加恢复索引的 SQL
  - 添加恢复数据的 SQL
  - _需求: 7.2_

- [ ]* 5.3 测试数据库迁移脚本
  - 在测试环境执行迁移脚本
  - 验证字段和索引被正确移除
  - 验证数据完整性
  - 测试回滚脚本
  - _需求: 1.1, 1.2, 1.3, 1.5, 7.2, 7.4_

- [ ]* 5.4 编写数据迁移完整性测试
  - **属性 8: 数据迁移完整性**
  - **验证需求: 1.5, 7.4, 8.4**

- [ ] 6. 阶段2: 数据库迁移 - 执行迁移
  - 在生产环境执行数据库迁移
  - _需求: 1.1, 1.2, 1.3, 1.5_

- [ ] 6.1 备份生产数据库
  - 创建完整的数据库备份
  - 验证备份文件完整性
  - _需求: 7.1_

- [ ] 6.2 执行生产环境迁移
  - 在维护窗口执行迁移脚本
  - 记录迁移日志
  - 验证迁移结果
  - _需求: 1.1, 1.2, 1.3_

- [ ] 6.3 验证迁移后的数据完整性
  - 检查表结构
  - 检查数据记录数量
  - 检查核心字段数据
  - _需求: 1.4, 1.5_

- [x] 7. 检查点 - 数据库迁移完成
  - 确保迁移成功，数据完整，询问用户是否有问题

- [ ] 8. 阶段3: 集成测试 - 验证关联功能
  - 测试所有使用分类的功能模块
  - _需求: 6.1, 6.2, 6.3_

- [ ]* 8.1 测试优惠券-分类集成
  - 创建测试分类
  - 创建指定分类的优惠券
  - 验证优惠券能正确关联分类
  - 验证优惠券列表能正确显示分类信息
  - _需求: 6.1_

- [ ]* 8.2 测试工作人员-分类集成
  - 创建测试分类
  - 创建关联分类的工作人员
  - 验证工作人员能正确关联分类
  - 验证工作人员列表能正确显示分类信息
  - 验证有关联工作人员的分类无法删除
  - _需求: 6.2_

- [ ]* 8.3 测试服务套餐-分类集成
  - 创建测试分类
  - 创建关联分类的服务套餐
  - 验证服务套餐能正确关联分类
  - 验证服务套餐列表能正确显示分类信息
  - _需求: 6.3_

- [ ]* 8.4 编写关联功能兼容性属性测试
  - **属性 9: 关联功能兼容性**
  - **验证需求: 6.1, 6.2, 6.3**

- [ ] 9. 阶段3: API测试 - 验证接口兼容性
  - 测试所有分类相关的API接口
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_

- [ ]* 9.1 测试分类列表接口
  - 调用 /adminapi/service/category/lists 接口
  - 验证返回扁平列表
  - 验证响应格式
  - _需求: 5.1_

- [ ]* 9.2 测试分类树形接口
  - 调用 /adminapi/service/category/tree 接口
  - 验证返回扁平列表（向后兼容）
  - 验证响应格式
  - _需求: 5.1_

- [ ]* 9.3 测试分类详情接口
  - 调用 /adminapi/service/category/detail 接口
  - 验证返回完整字段
  - 验证响应格式
  - _需求: 5.2_

- [ ]* 9.4 测试分类添加接口
  - 调用 /adminapi/service/category/add 接口
  - 验证成功创建分类
  - 验证名称唯一性检查
  - 验证响应格式
  - _需求: 5.3_

- [ ]* 9.5 测试分类编辑接口
  - 调用 /adminapi/service/category/edit 接口
  - 验证成功更新分类
  - 验证名称唯一性检查
  - 验证响应格式
  - _需求: 5.4_

- [ ]* 9.6 测试分类删除接口
  - 调用 /adminapi/service/category/delete 接口
  - 验证成功删除分类
  - 验证关联检查
  - 验证响应格式
  - _需求: 5.5_

- [ ]* 9.7 测试分类状态切换接口
  - 调用 /adminapi/service/category/changeStatus 接口
  - 验证成功切换状态
  - 验证响应格式
  - _需求: 5.6_

- [ ]* 9.8 编写API响应格式一致性属性测试
  - **属性 7: API响应格式一致性**
  - **验证需求: 5.7, 8.5**

- [ ] 10. 阶段3: 性能测试 - 验证性能改进
  - 测试重构后的性能指标
  - _需求: 10.1, 10.2, 10.3, 10.4_

- [ ]* 10.1 测试查询性能
  - 创建大量测试数据（1000条分类）
  - 测试列表查询响应时间
  - 测试详情查询响应时间
  - 验证响应时间 < 100ms
  - _需求: 10.1_

- [ ]* 10.2 测试修改操作性能
  - 测试添加操作时间
  - 测试编辑操作时间
  - 测试删除操作时间
  - 测试状态切换操作时间
  - 验证操作时间 < 200ms
  - _需求: 10.2, 10.3, 10.4_

- [ ]* 10.3 编写查询性能属性测试
  - **属性 10: 查询性能要求**
  - **验证需求: 10.1, 10.2, 10.3, 10.4**

- [ ] 11. 检查点 - 测试完成
  - 确保所有测试通过，询问用户是否有问题

- [x] 12. 阶段4: 文档更新
  - 更新相关文档以反映重构后的系统状态
  - _需求: 9.1, 9.2, 9.3, 9.4_

- [x] 12.1 更新 API 文档
  - 更新分类相关接口文档
  - 移除 pid 和 level 字段说明
  - 更新请求和响应示例
  - _需求: 9.1_

- [x] 12.2 更新数据库设计文档
  - 更新服务分类表结构说明
  - 移除 pid 和 level 字段说明
  - 更新表关系图
  - _需求: 9.2_

- [x] 12.3 更新开发规范文档
  - 更新分类相关的开发规范
  - 添加扁平化分类的最佳实践
  - _需求: 9.3_

- [x] 12.4 更新重构设计文档状态
  - 将 doc/服务分类重构设计.md 标记为已完成
  - 添加实施总结
  - 记录遇到的问题和解决方案
  - _需求: 9.4_

- [x] 13. 最终检查点 - 重构完成
  - 确保所有任务完成，所有测试通过，所有文档更新

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以根据项目需求决定是否执行
- 每个任务都引用了具体的需求编号，便于追溯
- 属性测试任务明确标注了属性编号和验证的需求
- 检查点任务用于阶段性验证和用户确认
- 建议按顺序执行任务，确保每个阶段完成后再进入下一阶段
- 数据库迁移前务必备份数据
- 如遇到问题，可以使用回滚脚本恢复
