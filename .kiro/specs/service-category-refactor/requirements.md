# 需求文档 - 服务分类重构

## 简介

本项目旨在将婚庆管理系统中的服务分类从多级分类结构简化为扁平化结构。当前系统设计支持多级分类（包含 `pid`、`level` 字段），但实际业务需求是扁平化的服务类型（摄影师、化妆师、司仪主持等），不存在父子关系。此重构将移除冗余字段和逻辑，简化代码结构，提升系统可维护性。

## 术语表

- **ServiceCategory**: 服务分类模型，对应数据库表 `la_service_category`
- **CategoryLogic**: 服务分类业务逻辑层
- **CategoryController**: 服务分类控制器层
- **扁平化分类**: 所有分类处于同一层级，无父子关系的分类结构
- **树形结构**: 具有父子关系的多级分类结构
- **pid**: 父级分类ID字段
- **level**: 分类层级字段

## 需求

### 需求 1: 数据库结构简化

**用户故事:** 作为系统维护人员，我希望移除数据库中的冗余字段，以便简化数据结构并提升查询性能。

#### 验收标准

1. WHEN 执行数据库迁移脚本 THEN 系统应当成功移除 `la_service_category` 表中的 `level` 字段
2. WHEN 执行数据库迁移脚本 THEN 系统应当成功移除 `la_service_category` 表中的 `pid` 字段
3. WHEN 执行数据库迁移脚本 THEN 系统应当成功移除与 `pid` 和 `level` 相关的索引
4. WHEN 查询服务分类数据 THEN 系统应当正常返回所有必要字段（id、name、icon、image、sort、is_show、时间戳）
5. WHEN 数据库迁移完成后 THEN 现有的分类数据应当保持完整，不丢失任何记录

### 需求 2: 模型层代码简化

**用户故事:** 作为后端开发人员，我希望简化模型层代码，以便移除不必要的关联关系和方法。

#### 验收标准

1. WHEN 访问 ServiceCategory 模型 THEN 系统不应当包含 `parent()` 关联方法
2. WHEN 访问 ServiceCategory 模型 THEN 系统不应当包含 `children()` 关联方法
3. WHEN 访问 ServiceCategory 模型 THEN 系统不应当包含 `buildTree()` 方法
4. WHEN 调用分类查询方法 THEN 系统应当返回扁平化的分类列表
5. WHEN 模型代码简化后 THEN 所有现有的分类查询功能应当正常工作

### 需求 3: 业务逻辑层简化

**用户故事:** 作为后端开发人员，我希望简化业务逻辑层代码，以便移除树形结构处理和层级检查逻辑。

#### 验收标准

1. WHEN 调用 CategoryLogic::getAll() 方法 THEN 系统应当直接返回扁平化列表，不构建树形结构
2. WHEN 调用 CategoryLogic::add() 方法 THEN 系统不应当执行层级计算逻辑
3. WHEN 调用 CategoryLogic::add() 方法 THEN 系统不应当执行父级分类检查逻辑
4. WHEN 调用 CategoryLogic::edit() 方法 THEN 系统不应当执行层级计算逻辑
5. WHEN 调用 CategoryLogic::edit() 方法 THEN 系统不应当执行父子关系检查逻辑
6. WHEN 调用 CategoryLogic::delete() 方法 THEN 系统不应当执行子分类检查逻辑
7. WHEN 业务逻辑简化后 THEN 所有分类的增删改查操作应当正常工作

### 需求 4: 验证器层简化

**用户故事:** 作为后端开发人员，我希望简化验证器代码，以便移除不必要的字段验证规则。

#### 验收标准

1. WHEN 访问 CategoryValidate 验证器 THEN 系统不应当包含 `pid` 字段的验证规则
2. WHEN 访问 CategoryValidate 验证器 THEN 系统不应当包含 `level` 字段的验证规则
3. WHEN 提交分类表单数据 THEN 系统应当正确验证必填字段（name、sort、is_show）
4. WHEN 验证器简化后 THEN 所有分类表单验证应当正常工作

### 需求 5: API 接口兼容性

**用户故事:** 作为前端开发人员，我希望 API 接口保持向后兼容，以便避免前端代码大规模修改。

#### 验收标准

1. WHEN 调用分类列表接口 THEN 系统应当返回扁平化的分类数组
2. WHEN 调用分类详情接口 THEN 系统应当返回完整的分类信息
3. WHEN 调用分类添加接口 THEN 系统应当成功创建新分类
4. WHEN 调用分类编辑接口 THEN 系统应当成功更新分类信息
5. WHEN 调用分类删除接口 THEN 系统应当成功删除指定分类
6. WHEN 调用分类状态切换接口 THEN 系统应当成功切换分类显示状态
7. WHEN API 接口返回数据 THEN 响应格式应当保持与重构前一致

### 需求 6: 关联功能兼容性

**用户故事:** 作为系统用户，我希望所有使用服务分类的功能模块继续正常工作，以便不影响日常业务操作。

#### 验收标准

1. WHEN 在优惠券管理中选择指定分类 THEN 系统应当正确显示所有可用分类
2. WHEN 在工作人员管理中关联服务分类 THEN 系统应当正确保存和显示分类关联
3. WHEN 在服务套餐中关联服务分类 THEN 系统应当正确保存和显示分类关联
4. WHEN 在任何使用分类的功能中 THEN 分类数据应当正确加载和显示
5. WHEN 重构完成后 THEN 所有关联功能的数据完整性应当得到保证

### 需求 7: 数据迁移安全性

**用户故事:** 作为系统管理员，我希望数据迁移过程安全可靠，以便在出现问题时能够快速回滚。

#### 验收标准

1. WHEN 执行数据库迁移前 THEN 系统应当提供完整的数据库备份方案
2. WHEN 数据迁移失败 THEN 系统应当能够通过回滚脚本恢复到迁移前状态
3. WHEN 执行数据迁移 THEN 系统应当记录详细的迁移日志
4. WHEN 数据迁移完成后 THEN 系统应当验证数据完整性和一致性
5. WHEN 发现数据问题 THEN 系统应当提供明确的错误信息和修复建议

### 需求 8: 测试覆盖

**用户故事:** 作为质量保证人员，我希望有完整的测试覆盖，以便确保重构不会引入新的问题。

#### 验收标准

1. WHEN 执行单元测试 THEN 所有分类的增删改查操作应当通过测试
2. WHEN 执行集成测试 THEN 所有使用分类的功能模块应当通过测试
3. WHEN 执行回归测试 THEN 重构前后的功能行为应当保持一致
4. WHEN 测试数据迁移 THEN 迁移前后的数据应当完全一致
5. WHEN 测试 API 接口 THEN 所有接口的响应格式和数据应当符合预期

### 需求 9: 文档更新

**用户故事:** 作为开发团队成员，我希望相关文档得到及时更新，以便准确反映系统的当前状态。

#### 验收标准

1. WHEN 重构完成后 THEN API 文档应当更新以反映新的接口行为
2. WHEN 重构完成后 THEN 数据库设计文档应当更新以反映新的表结构
3. WHEN 重构完成后 THEN 开发规范文档应当更新以反映新的代码规范
4. WHEN 重构完成后 THEN 重构设计文档应当标记为已完成状态
5. WHEN 查阅文档 THEN 所有文档内容应当准确、清晰、易于理解

### 需求 10: 性能优化

**用户故事:** 作为系统用户，我希望重构后的系统性能得到提升，以便获得更快的响应速度。

#### 验收标准

1. WHEN 查询分类列表 THEN 响应时间应当不超过 100ms
2. WHEN 添加新分类 THEN 操作应当在 200ms 内完成
3. WHEN 编辑分类 THEN 操作应当在 200ms 内完成
4. WHEN 删除分类 THEN 操作应当在 200ms 内完成
5. WHEN 执行批量查询 THEN 系统应当支持分类数据缓存以提升性能
