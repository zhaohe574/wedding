# 需求文档：装修组件动态数据加载

## 简介

当前装修组件（员工展示、服务套餐等）在保存时会将完整的数据快照存储到装修配置中。这导致当原始数据（如员工头像、套餐价格）更新后，装修组件无法自动显示最新信息。本需求旨在实现装修组件的动态数据加载机制，确保组件始终显示最新的数据。

## 术语表

- **装修组件（Decoration_Widget）**: 用于页面装修的可配置组件，如员工展示、服务套餐展示等
- **装修数据（Decoration_Data）**: 存储在数据库中的装修配置数据
- **引用ID（Reference_ID）**: 指向原始数据的标识符（如 staff_id、package_id）
- **原始数据（Source_Data）**: 存储在业务表中的实际数据（如员工表、套餐表）
- **数据快照（Data_Snapshot）**: 保存时复制的完整数据副本
- **动态加载（Dynamic_Loading）**: 在渲染时根据引用ID实时获取最新数据

## 需求

### 需求 1：装修组件数据存储优化

**用户故事：** 作为管理员，我希望装修组件只存储引用ID而不是完整数据，这样当我修改原始数据时，前端展示能自动更新。

#### 验收标准

1. WHEN 管理员在装修后台选择员工或套餐时，THE 系统 SHALL 只存储引用ID（staff_id、package_id）和显示控制字段（is_show、排序等）
2. WHEN 管理员保存装修配置时，THE 系统 SHALL 不存储头像、名称、价格等业务数据的快照
3. WHEN 装修数据包含旧的快照数据时，THE 系统 SHALL 能够兼容并正常处理
4. THE 装修数据结构 SHALL 保持向后兼容，支持已有的装修配置

### 需求 2：前端动态数据获取

**用户故事：** 作为用户，我希望在浏览页面时看到的员工信息、套餐信息都是最新的，而不是过时的快照数据。

#### 验收标准

1. WHEN 前端渲染装修组件时，THE 系统 SHALL 根据引用ID列表批量查询最新的原始数据
2. WHEN 原始数据不存在或已删除时，THE 系统 SHALL 自动过滤该项，不显示在前端
3. WHEN 原始数据的状态为禁用时，THE 系统 SHALL 根据配置决定是否显示
4. THE 系统 SHALL 在单次请求中批量获取所有需要的数据，避免N+1查询问题

### 需求 3：后台预览实时更新

**用户故事：** 作为管理员，我希望在装修后台的预览区域能实时看到最新的数据，而不需要重新选择。

#### 验收标准

1. WHEN 管理员在装修后台查看预览时，THE 系统 SHALL 显示最新的原始数据
2. WHEN 管理员更换选择的员工或套餐时，THE 系统 SHALL 立即获取并显示新的数据
3. WHEN 原始数据在其他地方被修改时，THE 装修后台预览 SHALL 在刷新后显示最新数据
4. THE 系统 SHALL 在预览区域显示数据加载状态，提供良好的用户体验

### 需求 4：数据一致性保障

**用户故事：** 作为系统管理员，我希望系统能够处理数据不一致的情况，确保前端不会因为数据问题而崩溃。

#### 验收标准

1. WHEN 引用的原始数据被删除时，THE 系统 SHALL 优雅地处理，不显示该项
2. WHEN 批量查询数据时部分ID无效时，THE 系统 SHALL 只返回有效的数据
3. WHEN 数据库查询失败时，THE 系统 SHALL 返回空数组而不是抛出异常
4. THE 系统 SHALL 记录数据不一致的情况到日志，便于排查问题

### 需求 5：性能优化

**用户故事：** 作为用户，我希望页面加载速度快，不会因为动态加载数据而变慢。

#### 验收标准

1. WHEN 装修组件需要加载数据时，THE 系统 SHALL 使用批量查询而不是逐个查询
2. WHEN 同一页面有多个装修组件时，THE 系统 SHALL 合并相同类型的数据请求
3. WHEN 数据被查询后，THE 系统 SHALL 在合理的时间内缓存结果
4. THE 系统 SHALL 只查询必要的字段，不加载冗余数据

### 需求 6：管理后台兼容性

**用户故事：** 作为管理员，我希望在装修后台能够看到选中项的基本信息，即使采用了动态加载机制。

#### 验收标准

1. WHEN 管理员在装修后台查看已选择的项目时，THE 系统 SHALL 显示项目的名称和关键信息
2. WHEN 管理员打开装修配置时，THE 系统 SHALL 自动加载所有引用项的最新数据
3. WHEN 引用的数据不存在时，THE 系统 SHALL 显示"数据已删除"等提示信息
4. THE 系统 SHALL 提供"刷新数据"功能，允许管理员手动更新预览

### 需求 7：API接口设计

**用户故事：** 作为开发者，我希望有清晰的API接口来支持动态数据加载功能。

#### 验收标准

1. THE 系统 SHALL 提供批量查询员工信息的API接口（根据ID列表）
2. THE 系统 SHALL 提供批量查询套餐信息的API接口（根据ID列表）
3. THE 系统 SHALL 提供装修数据解析接口，自动填充引用数据
4. WHEN API接收到空的ID列表时，THE 系统 SHALL 返回空数组而不是错误

### 需求 8：数据迁移支持

**用户故事：** 作为系统管理员，我希望已有的装修配置能够平滑迁移到新的数据结构。

#### 验收标准

1. THE 系统 SHALL 能够识别旧格式的装修数据（包含完整快照）
2. WHEN 系统检测到旧格式数据时，THE 系统 SHALL 自动提取引用ID并使用动态加载
3. THE 系统 SHALL 提供数据迁移工具，批量转换旧格式到新格式
4. WHEN 迁移过程中出现错误时，THE 系统 SHALL 保留原始数据不做修改
