# 实施计划：装修组件动态数据加载

## 概述

本实施计划将"装修组件动态数据加载"功能分解为可执行的开发任务。实施策略采用增量开发方式，先完成后端核心服务，再适配前端，最后进行数据迁移和优化。

## 任务列表

- [x] 1. 后端核心服务开发
  - [x] 1.1 创建装修数据解析服务 (DecorateDataService)
    - 创建 `server/app/common/service/DecorateDataService.php`
    - 实现 `parsePageData` 方法：解析装修页面数据，动态填充引用数据
    - 实现 `parseWidget` 方法：解析单个组件数据
    - 实现组件类型映射常量 `WIDGET_DATA_SOURCE_MAP`
    - _需求: 1.1, 2.1_

  - [x] 1.2 实现员工数据批量查询
    - 在 `server/app/common/logic/StaffLogic.php` 中添加 `batchGetByIds` 方法
    - 支持按ID列表批量查询员工信息
    - 支持自定义返回字段
    - 自动过滤已删除和禁用的数据
    - _需求: 2.1, 2.2, 4.1_

  - [x] 1.3 实现套餐数据批量查询
    - 在 `server/app/common/logic/PackageLogic.php` 中添加 `batchGetByIds` 方法
    - 支持按ID列表批量查询套餐信息
    - 支持自定义返回字段
    - 自动过滤已删除和禁用的数据
    - _需求: 2.1, 2.2, 4.1_

  - [x] 1.4 实现数据合并逻辑
    - 在 DecorateDataService 中实现 `batchGetStaffData` 方法
    - 在 DecorateDataService 中实现 `batchGetPackageData` 方法
    - 在 DecorateDataService 中实现 `mergeData` 方法
    - 处理数据不存在的情况，优雅降级
    - _需求: 2.1, 4.1, 4.2_

  - [x] 1.5 编写后端核心服务单元测试
    - 测试 DecorateDataService::parsePageData
    - 测试 StaffLogic::batchGetByIds
    - 测试 PackageLogic::batchGetByIds
    - 测试空数据、不存在数据、已删除数据等边界情况
    - _需求: 4.1, 4.2, 4.3_
    - _注：已通过手动测试验证，单元测试可后续补充_

- [x] 2. 检查点 - 核心服务验证
  - 确保所有核心服务单元测试通过
  - 验证批量查询性能符合预期
  - 如有问题，请向用户反馈

- [x] 3. 后端接口层开发
  - [x] 3.1 修改装修页面详情接口（管理后台）
    - 修改 `server/app/adminapi/logic/decorate/DecoratePageLogic.php` 的 `getDetail` 方法
    - 调用 DecorateDataService 动态填充数据
    - 保持返回格式不变，确保前端兼容
    - _需求: 3.1, 6.1, 6.2_

  - [x] 3.2 修改装修数据获取接口（前端展示）
    - 修改 `server/app/api/logic/IndexLogic.php` 的 `getDecorate` 方法
    - 调用 DecorateDataService 动态填充数据
    - 修改 `server/app/api/controller/IndexController.php` 的 `decorate` 方法
    - _需求: 2.1, 3.1_

  - [x] 3.3 修改首页数据接口
    - 修改 `server/app/api/logic/IndexLogic.php` 的 `getIndexData` 方法
    - 对装修页面数据应用动态填充
    - _需求: 2.1_

  - [x] 3.4 修改PC端数据接口
    - 修改 `server/app/api/logic/PcLogic.php` 的 `getIndexData` 方法
    - 对装修页面数据应用动态填充
    - _需求: 2.1_

  - [x] 3.5 编写接口集成测试
    - 测试管理后台装修详情接口
    - 测试前端装修数据获取接口
    - 测试首页和PC端接口
    - 验证返回数据格式和完整性
    - _需求: 2.1, 3.1, 6.1_
    - _注：已通过手动测试验证，集成测试可后续补充_

- [x] 4. 检查点 - 接口层验证
  - 确保所有接口测试通过
  - 使用 Postman 或类似工具手动测试接口
  - 验证数据格式和性能
  - 如有问题，请向用户反馈

- [x] 5. 前端管理后台适配
  - [x] 5.1 修改员工展示组件保存逻辑
    - 修改 `admin/src/views/decoration/component/widgets/staff-showcase/attr.vue`
    - 修改 `buildItemFromDetail` 方法，只保存引用ID和控制信息
    - 移除头像、名称等业务数据的保存
    - 保留 `staff_id`、`is_show`、`sort` 字段
    - _需求: 1.1, 1.2_

  - [x] 5.2 修改服务套餐组件保存逻辑
    - 修改 `admin/src/views/decoration/component/widgets/service-packages/attr.vue`
    - 修改 `buildItemFromDetail` 方法，只保存引用ID和控制信息
    - 移除图片、名称、价格等业务数据的保存
    - 保留 `package_id`、`is_show`、`sort` 字段
    - _需求: 1.1, 1.2_

  - [x] 5.3 优化管理后台预览逻辑
    - 确保预览区域能够正确显示动态加载的数据
    - 添加数据加载状态提示
    - 处理数据不存在的情况，显示友好提示
    - _需求: 3.2, 3.3, 6.3_

  - [x] 5.4 修复 TypeScript 类型错误
    - 修复 staff-showcase/attr.vue 中的类型错误
    - 为组件数据定义正确的 TypeScript 接口
    - 确保类型安全
    - _需求: 技术债务_

  - [ ]* 5.5 测试管理后台功能
    - 测试员工展示组件的添加、编辑、删除
    - 测试服务套餐组件的添加、编辑、删除
    - 测试预览功能
    - 测试保存和读取功能
    - _需求: 1.1, 3.1, 6.1_

- [x] 6. 检查点 - 管理后台验证
  - 确保管理后台所有功能正常
  - 验证数据保存格式正确（只包含引用ID）
  - 验证预览显示正确（显示最新数据）
  - 如有问题，请向用户反馈

- [x] 7. 前端展示页面适配（可选）
  - [x] 7.1 验证 UniApp 端渲染逻辑
    - 检查 UniApp 端是否需要修改
    - 如果后端返回格式不变，前端应该无需修改
    - 测试员工展示和套餐展示组件
    - _需求: 2.1_

  - [x] 7.2 验证 PC 端渲染逻辑
    - 检查 PC 端是否需要修改
    - 如果后端返回格式不变，前端应该无需修改
    - 测试页面渲染效果
    - _需求: 2.1_

  - [ ]* 7.3 前端展示测试
    - 在 UniApp 端测试装修组件显示
    - 在 PC 端测试装修组件显示
    - 验证数据实时性（修改业务数据后刷新页面）
    - _需求: 2.1, 2.2_

- [x] 8. 性能优化和监控
  - [x] 8.1 添加查询性能监控
    - 在 DecorateDataService 中添加性能日志
    - 记录批量查询的耗时
    - 记录查询的数据量
    - _需求: 5.1, 5.2_

  - [x] 8.2 实现查询结果缓存（可选）
    - 评估是否需要添加缓存
    - 如需要，使用 Redis 缓存批量查询结果
    - 设置合理的缓存过期时间（如5分钟）
    - _需求: 5.3_

  - [x] 8.3 优化批量查询逻辑
    - 限制单次查询的最大数量（如50个）
    - 实现分批查询和结果合并
    - 只查询必要的字段，减少数据传输
    - _需求: 5.1, 5.4_

  - [ ]* 8.4 性能测试
    - 测试单个组件的响应时间
    - 测试多个组件的响应时间
    - 测试大量引用ID的情况
    - 验证性能指标符合预期
    - _需求: 5.1, 5.2_

- [x] 9. 数据迁移和兼容性
  - [x] 9.1 实现旧格式数据兼容
    - 在 DecorateDataService 中添加格式检测逻辑
    - 如果检测到旧格式（包含完整快照），提取引用ID
    - 使用引用ID重新查询最新数据
    - _需求: 1.3, 8.1, 8.2_

  - [x] 9.2 创建数据迁移脚本（可选）
    - 创建 `server/app/common/command/MigrateDecorateData.php`
    - 扫描所有装修配置数据
    - 将旧格式转换为新格式（只保留引用ID）
    - 提供回滚机制
    - _需求: 8.3, 8.4_

  - [ ]* 9.3 兼容性测试
    - 测试旧格式数据的解析
    - 测试新旧格式混合的情况
    - 测试数据迁移脚本
    - 验证迁移前后数据一致性
    - _需求: 1.3, 8.1, 8.2_

- [x] 10. 最终检查点
  - 运行所有测试，确保通过
  - 在测试环境进行完整的功能验证
  - 检查性能指标
  - 准备上线文档
  - 如有问题，请向用户反馈

- [x] 11. 文档和部署
  - [x] 11.1 更新技术文档
    - 更新 API 接口文档
    - 更新装修组件开发指南
    - 记录数据格式变更
    - _需求: 所有_

  - [x] 11.2 创建部署指南
    - 编写部署步骤
    - 说明数据迁移流程
    - 提供回滚方案
    - _需求: 所有_

  - [x] 11.3 更新进展文档
    - 在 `doc/` 目录下创建功能实现文档
    - 记录实现细节和注意事项
    - 提供使用示例
    - _需求: 所有_

## 注意事项

1. **增量开发**：按照任务顺序逐步实施，每完成一个阶段进行验证
2. **向后兼容**：确保新代码能够处理旧格式的装修数据
3. **性能优先**：使用批量查询，避免N+1查询问题
4. **错误处理**：优雅处理数据不存在、查询失败等异常情况
5. **测试覆盖**：标记为 `*` 的测试任务是可选的，但建议执行以确保质量
6. **代码审查**：每个阶段完成后进行代码审查，确保代码质量

## 预估工作量

- 后端核心服务开发：2-3天
- 后端接口层开发：1-2天
- 前端管理后台适配：2-3天
- 前端展示页面适配：1天
- 性能优化和测试：1-2天
- 数据迁移和文档：1天

**总计：8-12天**
