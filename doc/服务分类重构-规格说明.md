# 服务分类重构 - 规格说明文档

**创建日期:** 2026-01-23  
**文档版本:** v1.0  
**状态:** 规格创建完成，待执行

---

## 一、规格文档概述

本规格文档位于 `.kiro/specs/service-category-refactor/` 目录，包含三个核心文档：

### 1.1 需求文档 (requirements.md)

定义了服务分类重构的10个核心需求：

1. **数据库结构简化** - 移除 `pid` 和 `level` 冗余字段
2. **模型层代码简化** - 移除树形结构相关方法
3. **业务逻辑层简化** - 移除层级检查和树形构建逻辑
4. **验证器层简化** - 移除冗余字段验证
5. **API接口兼容性** - 保持向后兼容
6. **关联功能兼容性** - 确保优惠券、工作人员等模块正常工作
7. **数据迁移安全性** - 提供备份和回滚方案
8. **测试覆盖** - 确保质量
9. **文档更新** - 保持文档同步
10. **性能优化** - 提升响应速度

每个需求都包含详细的验收标准，使用 EARS 模式定义，确保可测试性。

### 1.2 设计文档 (design.md)

详细描述了重构的技术方案：

#### 架构设计
- **当前架构**: 多级树形结构，包含 `pid`、`level` 字段，支持父子关系
- **目标架构**: 扁平化结构，移除冗余字段，简化查询逻辑

#### 组件设计
- **数据库层**: 移除 `pid`、`level` 字段和相关索引
- **模型层**: 移除 `parent()`、`children()`、`buildTree()` 等方法
- **逻辑层**: 简化 `add()`、`edit()`、`delete()`、`getAll()`、`tree()` 等方法
- **验证器层**: 移除 `pid`、`level` 字段验证规则

#### 正确性属性
定义了10个可测试的系统属性：

1. **扁平列表结构** - 所有查询返回扁平数组
2. **分类详情完整性** - 详情包含所有必要字段
3. **分类名称唯一性** - 名称不能重复
4. **CRUD操作幂等性** - 增删改查操作正确执行
5. **删除前置条件** - 有关联数据时拒绝删除
6. **表单验证正确性** - 验证规则正确工作
7. **API响应格式一致性** - 响应格式保持一致
8. **数据迁移完整性** - 迁移前后数据一致
9. **关联功能兼容性** - 关联模块正常工作
10. **查询性能要求** - 满足性能指标

#### 测试策略
- **单元测试**: 测试各个组件的独立功能
- **属性测试**: 使用 PHPUnit 验证10个正确性属性，每个属性至少100次迭代
- **集成测试**: 测试优惠券、工作人员、服务套餐等关联功能
- **数据迁移测试**: 验证迁移的安全性和正确性
- **回归测试**: 确保重构不影响现有功能
- **性能测试**: 验证性能改进

#### 实施计划
分为4个阶段：
1. **代码重构** (4-6小时) - 简化业务逻辑
2. **数据库迁移** (2-3小时) - 移除冗余字段
3. **前端优化** (3-4小时) - 优化前端交互
4. **文档更新** (1-2小时) - 更新相关文档

### 1.3 任务文档 (tasks.md)

将设计转化为可执行的任务列表，共13个主任务，包含：

#### 阶段1: 代码重构 (任务 1-4)
- 简化 CategoryLogic 类的7个方法
- 简化 ServiceCategory 模型
- 简化 CategoryValidate 验证器
- 包含可选的属性测试任务

#### 阶段2: 数据库迁移 (任务 5-7)
- 创建迁移和回滚脚本
- 执行生产环境迁移
- 验证数据完整性
- 包含可选的迁移测试任务

#### 阶段3: 集成测试 (任务 8-11)
- 测试关联功能（优惠券、工作人员、服务套餐）
- 测试API接口兼容性
- 测试性能改进
- 所有测试任务都是可选的

#### 阶段4: 文档更新 (任务 12-13)
- 更新API文档
- 更新数据库设计文档
- 更新开发规范文档
- 更新重构设计文档状态

---

## 二、关键设计决策

### 2.1 为什么选择扁平化结构？

**业务需求分析:**
- 当前分类：摄影师、摄像师、化妆师、司仪主持、婚礼策划、花艺师、跟妆师、灯光师
- 这些都是独立的服务类型，不存在父子关系
- 实际数据中所有分类的 `pid` 都是 0，`level` 都是 1

**技术优势:**
- 简化查询逻辑，无需递归构建树形结构
- 减少数据库字段和索引，提升查询性能
- 降低代码复杂度，提高可维护性
- 减少潜在的bug（如循环引用、层级限制等）

### 2.2 为什么分阶段实施？

**风险控制:**
- 先修改代码，后修改数据库，降低回滚难度
- 每个阶段都有检查点，便于发现和解决问题
- 可以在测试环境充分验证后再上生产

**灵活性:**
- 可以根据实际情况调整实施节奏
- 可以在任何阶段暂停或回滚
- 可以根据测试结果优化后续步骤

### 2.3 为什么保持API向后兼容？

**最小化影响:**
- 避免前端代码大规模修改
- 避免影响现有的集成功能
- 降低重构风险

**实现方式:**
- `tree()` 接口仍然存在，但返回扁平列表
- 响应格式保持一致，只是移除 `pid` 和 `level` 字段
- 所有接口的行为保持不变

---

## 三、测试策略说明

### 3.1 属性测试 vs 单元测试

**属性测试 (Property-Based Testing):**
- 验证通用的正确性属性
- 使用随机数据生成器
- 每个属性至少测试100次
- 适合验证系统的整体行为

**单元测试 (Unit Testing):**
- 验证具体的功能点
- 使用固定的测试数据
- 适合验证边界情况和错误处理

**互补关系:**
- 属性测试覆盖广度，单元测试覆盖深度
- 属性测试发现意外的bug，单元测试验证已知的场景
- 两者结合提供全面的测试覆盖

### 3.2 可选测试任务说明

**为什么标记为可选？**
- 核心功能的正确性可以通过代码审查和手动测试验证
- 属性测试需要额外的测试框架和数据生成器
- 可以根据项目时间和资源决定是否执行

**建议执行的测试:**
- 数据迁移测试（任务 5.3, 5.4）- 确保数据安全
- 关联功能测试（任务 8.1-8.4）- 确保集成正常
- API接口测试（任务 9.1-9.8）- 确保兼容性

**可以延后的测试:**
- 性能测试（任务 10.1-10.3）- 可以在上线后监控
- 部分属性测试 - 可以在后续迭代中补充

---

## 四、风险和缓解措施

### 4.1 数据丢失风险

**风险等级:** 高

**缓解措施:**
- ✅ 在迁移前创建完整的数据库备份
- ✅ 使用事务包装迁移操作
- ✅ 在测试环境充分测试
- ✅ 准备回滚脚本

### 4.2 功能兼容性风险

**风险等级:** 中

**缓解措施:**
- ✅ 保持API接口向后兼容
- ✅ 进行充分的回归测试
- ✅ 分阶段实施，逐步验证

### 4.3 性能风险

**风险等级:** 低

**缓解措施:**
- ✅ 进行性能测试
- ✅ 监控系统运行指标
- ✅ 如有必要，添加缓存机制

### 4.4 业务需求变更风险

**风险等级:** 低

**缓解措施:**
- ✅ 与产品团队确认业务需求
- ✅ 保持代码的可扩展性
- ✅ 如需恢复，可以重新添加字段

---

## 五、执行指南

### 5.1 如何开始执行任务？

1. **打开任务文档**
   - 在 VS Code 中打开 `.kiro/specs/service-category-refactor/tasks.md`
   - 查看任务列表

2. **选择任务**
   - 从第一个任务开始
   - 或者询问 Kiro 推荐下一个任务

3. **执行任务**
   - 点击任务旁边的 "Start task" 按钮
   - 或者告诉 Kiro "执行任务 1.1"

4. **验证结果**
   - 每个任务完成后，Kiro 会停下来让你审查
   - 确认无误后，继续下一个任务

### 5.2 如何处理测试任务？

**可选测试任务（带 `*` 标记）:**
- 可以跳过，直接进入下一个必需任务
- 也可以执行，获得更全面的测试覆盖

**必需任务:**
- 必须执行，确保核心功能正确

### 5.3 如何处理检查点？

**检查点任务的作用:**
- 阶段性验证
- 用户确认
- 发现和解决问题

**执行检查点时:**
1. Kiro 会总结当前阶段的完成情况
2. 询问是否有问题或疑问
3. 确认无误后，进入下一阶段

---

## 六、相关文档

### 6.1 规格文档
- `.kiro/specs/service-category-refactor/requirements.md` - 需求文档
- `.kiro/specs/service-category-refactor/design.md` - 设计文档
- `.kiro/specs/service-category-refactor/tasks.md` - 任务文档

### 6.2 原始设计文档
- `doc/服务分类重构设计.md` - 原始的重构设计文档

### 6.3 代码文件
- `server/app/common/model/service/ServiceCategory.php` - 分类模型
- `server/app/adminapi/logic/service/CategoryLogic.php` - 分类逻辑层
- `server/app/adminapi/controller/service/CategoryController.php` - 分类控制器
- `server/app/adminapi/validate/service/CategoryValidate.php` - 分类验证器

### 6.4 数据库文件
- `server/sql/wedding/016_add_service_category_level.sql` - 添加 level 字段（已执行）
- `server/sql/wedding/017_simplify_service_category.sql` - 简化表结构（待创建）
- `server/sql/wedding/017_rollback_simplify_service_category.sql` - 回滚脚本（待创建）

---

## 七、下一步行动

### 7.1 立即可以开始的任务

**任务 1.1: 简化 CategoryLogic::add() 方法**
- 这是第一个代码重构任务
- 不涉及数据库修改，风险低
- 可以立即开始

**执行命令:**
```
执行任务 1.1
```

### 7.2 建议的执行顺序

1. **完成阶段1的所有代码重构任务** (任务 1-4)
   - 修改代码，不修改数据库
   - 可以随时回滚
   - 风险最低

2. **执行阶段2的数据库迁移** (任务 5-7)
   - 在测试环境充分测试
   - 备份生产数据库
   - 选择合适的维护窗口

3. **执行阶段3的集成测试** (任务 8-11)
   - 验证所有功能正常
   - 发现和解决问题

4. **完成阶段4的文档更新** (任务 12-13)
   - 更新文档
   - 总结经验

---

## 八、总结

本规格文档为服务分类重构提供了完整的指导：

✅ **需求明确** - 10个核心需求，每个都有详细的验收标准  
✅ **设计完整** - 详细的架构设计、组件设计、正确性属性  
✅ **任务清晰** - 13个主任务，每个都有具体的实施步骤  
✅ **风险可控** - 识别了4类风险，提供了缓解措施  
✅ **可执行性强** - 分阶段实施，每个阶段都有检查点  

**预计总工作量:** 10-15小时  
**建议执行方式:** 分阶段执行，每个阶段充分验证后再进入下一阶段  
**风险等级:** 中等（主要风险是数据迁移，已有充分的缓解措施）

---

**文档状态:** 已完成  
**审核状态:** 待审核  
**实施状态:** 待执行

**创建人:** Kiro AI  
**创建时间:** 2026-01-23  
**最后更新:** 2026-01-23
