# 动态评论审核功能 - 实施进展

## 实施日期
2025-01-24

## 功能概述
为动态评论系统添加审核功能，允许管理员在后台配置是否启用评论审核，并提供专门的审核管理界面来审核或拒绝用户发表的评论。

## 已完成任务

### 1. 数据库层 ✅
- [x] 创建数据库迁移文件 `019_add_comment_review_fields.sql`
- [x] 添加 4 个新字段到 `la_dynamic_comment` 表：
  - `review_status` - 审核状态（0=待审核，1=已通过，2=已拒绝）
  - `review_admin_id` - 审核管理员ID
  - `review_time` - 审核时间
  - `review_remark` - 审核备注/拒绝原因
- [x] 为已存在的评论设置默认值（review_status = 1）

### 2. 后端模型层 ✅
- [x] 更新 `DynamicComment` 模型
  - 添加审核状态常量（REVIEW_STATUS_PENDING, REVIEW_STATUS_APPROVED, REVIEW_STATUS_REJECTED）
  - 修改 `addComment()` 方法，根据配置设置审核状态
  - 添加 `approveComment()` 方法 - 审核通过
  - 添加 `rejectComment()` 方法 - 拒绝评论
  - 添加 `getReviewStatusDescAttr()` 获取器 - 审核状态描述
  - 修改 `getCommentList()` 方法 - 只返回已通过审核的评论

### 3. 后端业务逻辑层 ✅
- [x] 创建 `DynamicCommentLogic` 类
  - `getReviewList()` - 获取待审核评论列表
  - `approve()` - 审核通过单个评论
  - `reject()` - 拒绝单个评论
  - `batchApprove()` - 批量审核通过
  - `batchReject()` - 批量拒绝
  - `getReviewConfig()` - 获取审核配置
  - `setReviewConfig()` - 设置审核配置

### 4. 后端验证器 ✅
- [x] 创建 `DynamicCommentValidate` 验证器
  - 定义验证规则（id, ids, remark, enabled）
  - 定义验证场景（approve, reject, batchApprove, batchReject, setConfig）

### 5. 后端控制器 ✅
- [x] 创建 `DynamicCommentController` 控制器
  - `reviewList()` - 获取待审核评论列表
  - `approve()` - 审核通过
  - `reject()` - 拒绝评论
  - `batchApprove()` - 批量通过
  - `batchReject()` - 批量拒绝
  - `getReviewConfig()` - 获取配置
  - `setReviewConfig()` - 设置配置

### 6. 前端 API 接口 ✅
- [x] 在 `admin/src/api/dynamic.ts` 中添加评论审核相关接口
  - `apiGetReviewConfig()` - 获取审核配置
  - `apiSetReviewConfig()` - 设置审核配置
  - `apiGetReviewList()` - 获取待审核评论列表
  - `apiApproveComment()` - 审核通过
  - `apiRejectComment()` - 拒绝评论
  - `apiBatchApproveComment()` - 批量通过
  - `apiBatchRejectComment()` - 批量拒绝

### 7. 后台管理界面 ✅
- [x] 创建配置页面 `admin/src/views/dynamic/config/index.vue`
  - 评论审核开关配置
  - 实时保存配置
- [x] 创建审核列表页面 `admin/src/views/dynamic/comment/review.vue`
  - 待审核评论列表展示
  - 单个审核操作（通过/拒绝）
  - 批量审核操作
  - 拒绝原因输入弹窗

## 待完成任务

### 8. 移动端界面 ⏳
- [ ] 更新动态详情页面的评论发表提示
- [ ] 创建"我的评论"页面
- [ ] 实现审核状态显示
- [ ] 实现拒绝原因显示

### 9. 后端 API - 我的评论接口 ⏳
- [ ] 创建用户评论查询接口
- [ ] 支持按审核状态筛选

### 10. 数据库迁移执行 ⏳
- [ ] 在开发环境执行 SQL 迁移
- [ ] 验证字段添加成功
- [ ] 检查数据默认值

### 11. 路由和菜单配置 ✅
- [x] 创建菜单配置 SQL 迁移文件 `020_add_comment_review_menus.sql`
- [x] 添加"评论审核"菜单项（sort=90）
- [x] 添加"动态配置"菜单项（sort=80）

### 12. 测试 ⏳
- [ ] 单元测试
- [ ] API 接口测试
- [ ] 端到端测试

## 核心功能说明

### 审核流程
1. 管理员在后台配置页面开启评论审核功能
2. 用户发表评论后，评论状态为"待审核"（review_status = 0）
3. 评论不会立即显示在评论列表中
4. 管理员在审核列表中查看待审核评论
5. 管理员可以选择"通过"或"拒绝"评论
6. 通过的评论会显示在评论列表中，评论计数增加
7. 拒绝的评论不会显示，用户可以在"我的评论"中看到拒绝原因

### 评论计数逻辑
- 只有 `review_status = 1`（已通过）的评论才计入 `comment_count`
- 待审核或已拒绝的评论不计入统计
- 审核通过时才更新动态的评论计数

### 配置管理
- 配置存储在 `config` 表中
- 分组：`dynamic`
- 键名：`comment_review_enabled`
- 值：0（关闭审核）或 1（开启审核）

## 技术实现要点

### 1. 审核状态管理
```php
// 审核状态常量
const REVIEW_STATUS_PENDING = 0;   // 待审核
const REVIEW_STATUS_APPROVED = 1;  // 已通过
const REVIEW_STATUS_REJECTED = 2;  // 已拒绝
```

### 2. 根据配置设置审核状态
```php
$reviewEnabled = ConfigService::get('dynamic', 'comment_review_enabled', 0);
$reviewStatus = $reviewEnabled ? self::REVIEW_STATUS_PENDING : self::REVIEW_STATUS_APPROVED;
```

### 3. 评论列表过滤
```php
$query->where('review_status', self::REVIEW_STATUS_APPROVED);
```

### 4. 批量操作
- 支持批量审核通过
- 支持批量拒绝（应用相同的拒绝原因）
- 返回操作结果统计（成功数量、失败数量）

## 下一步计划

1. **执行数据库迁移** - 在开发环境执行 SQL 文件
2. **完成移动端界面** - 实现评论发表提示和我的评论页面
3. **创建我的评论接口** - 后端 API 支持用户查询自己的评论
4. **配置路由和菜单** - 添加后台路由和菜单项
5. **测试验证** - 进行完整的功能测试

## 注意事项

1. **向后兼容** - 已存在的评论默认设置为"已通过"状态
2. **配置缓存** - 配置变更后需要清除缓存
3. **权限控制** - 审核接口需要管理员权限
4. **通知功能** - 审核结果通知功能标记为可选，可后续实现

## 文件清单

### 后端文件
- `server/sql/wedding/019_add_comment_review_fields.sql` - 数据库迁移
- `server/app/common/model/dynamic/DynamicComment.php` - 评论模型（已更新）
- `server/app/adminapi/logic/dynamic/DynamicCommentLogic.php` - 业务逻辑（新建）
- `server/app/adminapi/validate/dynamic/DynamicCommentValidate.php` - 验证器（新建）
- `server/app/adminapi/controller/dynamic/DynamicCommentController.php` - 控制器（新建）

### 前端文件
- `admin/src/api/dynamic.ts` - API 接口定义（已更新）
- `admin/src/views/dynamic/config/index.vue` - 配置页面（新建）
- `admin/src/views/dynamic/comment/review.vue` - 审核列表页面（新建）

### 菜单配置文件
- `server/sql/wedding/020_add_comment_review_menus.sql` - 菜单配置（新建）

