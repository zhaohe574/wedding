# 服务分类重构设计文档

**创建日期:** 2026-01-23  
**文档版本:** v1.0  
**负责人:** 开发团队

---

## 一、问题分析

### 1.1 当前问题
- 服务分类表 `la_service_category` 设计为支持多级分类（包含 `pid`、`level` 字段）
- 实际业务需求：婚庆服务分类是扁平化的，不需要子分类
- 当前分类：摄影师、摄像师、化妆师、司仪主持、婚礼策划、花艺师、跟妆师、灯光师等
- 这些分类都是独立的服务类型，不存在父子关系

### 1.2 设计冗余
- `pid` 字段（父级分类ID）：所有分类的 `pid` 都是 0，字段无实际意义
- `level` 字段（分类层级）：所有分类的 `level` 都是 1，字段无实际意义
- 树形结构逻辑：`buildTree()` 方法在扁平结构下无必要
- 层级检查逻辑：添加/编辑时的层级限制检查无必要

---

## 二、重构目标

### 2.1 简化数据结构
- 移除 `pid` 字段（父级分类ID）
- 移除 `level` 字段（分类层级）
- 保留核心字段：`id`、`name`、`icon`、`image`、`sort`、`is_show`、时间戳字段

### 2.2 简化业务逻辑
- 移除树形结构构建逻辑
- 移除层级检查逻辑
- 移除父子关系检查逻辑
- 简化查询和返回数据结构

### 2.3 保持向后兼容
- 前端接口返回格式保持一致
- 已有数据不受影响
- 分阶段平滑迁移

---

## 三、重构方案

### 3.1 数据库变更

#### 阶段一：添加字段（已完成）
```sql
-- 已创建：server/sql/wedding/016_add_service_category_level.sql
ALTER TABLE `la_service_category` 
ADD COLUMN `level` tinyint(1) UNSIGNED NOT NULL DEFAULT 1 COMMENT '分类层级:1-一级,2-二级,3-三级' AFTER `pid`;
```

#### 阶段二：移除冗余字段（待执行）
```sql
-- 创建：server/sql/wedding/017_simplify_service_category.sql
-- 1. 移除 level 字段
ALTER TABLE `la_service_category` DROP COLUMN `level`;

-- 2. 移除 pid 字段
ALTER TABLE `la_service_category` DROP COLUMN `pid`;

-- 3. 移除相关索引
ALTER TABLE `la_service_category` DROP INDEX `idx_pid`;
ALTER TABLE `la_service_category` DROP INDEX `idx_level`;
```

### 3.2 后端代码变更

#### 3.2.1 模型层 (ServiceCategory.php)
**变更内容：**
- 移除 `parent()` 关联方法
- 移除 `children()` 关联方法
- 移除 `buildTree()` 方法
- 简化 `getCategoryTree()` 方法为 `getCategoryList()`

**修改文件：** `server/app/common/model/service/ServiceCategory.php`

#### 3.2.2 逻辑层 (CategoryLogic.php)
**变更内容：**
- 移除 `tree()` 方法
- 移除 `buildTree()` 方法
- 简化 `add()` 方法：移除层级计算、父级检查
- 简化 `edit()` 方法：移除层级计算、父子关系检查
- 简化 `delete()` 方法：移除子分类检查
- 简化 `getAll()` 方法：直接返回列表，不构建树形结构

**修改文件：** `server/app/adminapi/logic/service/CategoryLogic.php`

#### 3.2.3 控制器层 (CategoryController.php)
**变更内容：**
- 移除 `tree()` 接口（或保留但返回扁平列表）
- 保持其他接口不变

**修改文件：** `server/app/adminapi/controller/service/CategoryController.php`

#### 3.2.4 验证器层 (CategoryValidate.php)
**变更内容：**
- 移除 `pid` 字段验证规则
- 移除 `level` 字段验证规则

**修改文件：** `server/app/adminapi/validate/service/CategoryValidate.php`

### 3.3 前端代码变更

#### 3.3.1 API 层
**变更内容：**
- `categoryTree()` 接口改为返回扁平列表（或废弃）
- `categoryAll()` 接口保持不变

**修改文件：** `admin/src/api/service.ts`

#### 3.3.2 视图层
**变更内容：**
- 分类管理页面：移除树形表格，改为普通表格
- 分类表单：移除父级分类选择器
- 分类选择器：使用扁平列表，不使用树形选择器

**修改文件：** 
- `admin/src/views/service/category/index.vue`（如果存在）
- 其他使用分类选择的页面

---

## 四、实施步骤

### 步骤 1：临时解决方案（立即执行）
**目标：** 解决当前 `level` 字段缺失导致的报错问题

**操作：**
1. ✅ 创建 SQL 文件添加 `level` 字段
2. ⏳ 手动执行 SQL 或通过数据库管理工具执行
3. ⏳ 验证接口是否正常工作

**SQL 文件：** `server/sql/wedding/016_add_service_category_level.sql`

### 步骤 2：简化逻辑层（短期优化）
**目标：** 简化代码逻辑，移除不必要的树形结构处理

**操作：**
1. 修改 `CategoryLogic::getAll()` 方法
   - 移除 `buildTree()` 调用
   - 直接返回扁平列表
2. 修改 `CategoryLogic::add()` 方法
   - 移除层级计算逻辑
   - 移除父级检查逻辑
3. 修改 `CategoryLogic::edit()` 方法
   - 移除层级计算逻辑
   - 移除父子关系检查逻辑
4. 修改 `CategoryLogic::delete()` 方法
   - 移除子分类检查逻辑

**预计工作量：** 1-2 小时

### 步骤 3：数据库结构优化（中期优化）
**目标：** 移除冗余字段，优化数据库结构

**操作：**
1. 创建 SQL 迁移文件
2. 备份数据库
3. 执行 SQL 移除 `pid` 和 `level` 字段
4. 更新模型类，移除相关字段定义
5. 测试所有相关功能

**SQL 文件：** `server/sql/wedding/017_simplify_service_category.sql`

**预计工作量：** 2-3 小时

### 步骤 4：前端优化（长期优化）
**目标：** 优化前端交互，移除树形组件

**操作：**
1. 检查所有使用分类的页面
2. 将树形选择器改为普通下拉选择
3. 将树形表格改为普通表格
4. 更新相关文档

**预计工作量：** 3-4 小时

---

## 五、风险评估

### 5.1 数据风险
- **风险：** 删除字段可能导致数据丢失
- **缓解措施：** 执行前完整备份数据库

### 5.2 兼容性风险
- **风险：** 前端代码可能依赖树形结构
- **缓解措施：** 分阶段执行，先保持接口兼容

### 5.3 业务风险
- **风险：** 未来可能需要子分类功能
- **缓解措施：** 
  - 与产品确认业务需求
  - 如需子分类，可以重新添加字段
  - 当前设计保持简单，避免过度设计

---

## 六、测试计划

### 6.1 单元测试
- [ ] 分类列表查询
- [ ] 分类详情查询
- [ ] 分类添加
- [ ] 分类编辑
- [ ] 分类删除
- [ ] 分类状态切换

### 6.2 集成测试
- [ ] 优惠券指定分类功能
- [ ] 工作人员关联分类功能
- [ ] 服务套餐关联分类功能
- [ ] 前端分类选择器功能

### 6.3 回归测试
- [ ] 所有使用分类的功能模块
- [ ] 数据迁移前后数据一致性

---

## 七、回滚方案

### 7.1 代码回滚
- 使用 Git 回退到重构前的提交
- 恢复备份的代码文件

### 7.2 数据库回滚
```sql
-- 如果需要恢复 pid 和 level 字段
ALTER TABLE `la_service_category` 
ADD COLUMN `pid` int(11) UNSIGNED NOT NULL DEFAULT 0 COMMENT '上级分类ID' AFTER `name`;

ALTER TABLE `la_service_category` 
ADD COLUMN `level` tinyint(1) UNSIGNED NOT NULL DEFAULT 1 COMMENT '分类层级' AFTER `pid`;

-- 恢复索引
ALTER TABLE `la_service_category` ADD KEY `idx_pid` (`pid`) USING BTREE;
ALTER TABLE `la_service_category` ADD KEY `idx_level` (`level`) USING BTREE;

-- 恢复数据
UPDATE `la_service_category` SET `pid` = 0, `level` = 1;
```

---

## 八、后续优化建议

### 8.1 代码优化
- 统一分类查询接口，避免多个相似接口
- 添加分类缓存，提升查询性能
- 完善分类相关的单元测试

### 8.2 功能优化
- 考虑添加分类图标库
- 考虑添加分类排序拖拽功能
- 考虑添加分类批量操作功能

### 8.3 文档优化
- 更新 API 文档
- 更新数据库设计文档
- 更新开发规范文档

---

## 九、相关文件清单

### 9.1 数据库文件
- `server/sql/wedding/001_create_staff_tables.sql` - 原始建表语句
- `server/sql/wedding/016_add_service_category_level.sql` - 添加 level 字段
- `server/sql/wedding/017_simplify_service_category.sql` - 简化表结构（待创建）

### 9.2 后端文件
- `server/app/common/model/service/ServiceCategory.php` - 分类模型
- `server/app/adminapi/logic/service/CategoryLogic.php` - 分类逻辑层
- `server/app/adminapi/controller/service/CategoryController.php` - 分类控制器
- `server/app/adminapi/validate/service/CategoryValidate.php` - 分类验证器
- `server/app/adminapi/lists/service/CategoryLists.php` - 分类列表（如果存在）

### 9.3 前端文件
- `admin/src/api/service.ts` - 分类 API 接口
- `admin/src/views/service/category/index.vue` - 分类管理页面（如果存在）
- `admin/src/views/coupon/lists/index.vue` - 优惠券管理（使用分类选择）
- 其他使用分类的页面

---

## 十、决策记录

### 决策 1：是否需要多级分类
- **决策：** 不需要
- **理由：** 婚庆服务分类是扁平化的，摄影师、化妆师等都是独立的服务类型
- **日期：** 2026-01-23

### 决策 2：是否立即移除冗余字段
- **决策：** 分阶段执行
- **理由：** 
  - 先添加字段解决报错问题
  - 再简化逻辑层代码
  - 最后移除冗余字段
- **日期：** 2026-01-23

### 决策 3：是否保留 tree 接口
- **决策：** 暂时保留，返回扁平列表
- **理由：** 保持向后兼容，避免前端报错
- **日期：** 2026-01-23

---

**文档状态：** 已完成（代码重构已完成）  
**审核状态：** 已审核  
**实施状态：** 代码重构完成，数据库迁移脚本已创建

## 最新进展

**2026-01-23 更新 - 代码重构完成:**

✅ **阶段1：代码重构** - 已完成
- 简化 CategoryLogic 类的所有方法（add、edit、delete、getAll、tree、detail）
- 移除 ServiceCategory 模型的树形结构方法（parent、children、buildTree、getCategoryTree）
- 添加 ServiceCategory::getCategoryList() 方法
- 简化 CategoryValidate 验证器（移除 pid 和 level 验证）

✅ **阶段2：数据库迁移脚本** - 已创建
- 创建迁移脚本：`server/sql/wedding/017_simplify_service_category.sql`
- 创建回滚脚本：`server/sql/wedding/017_rollback_simplify_service_category.sql`

⏳ **待执行任务:**
- 执行数据库迁移（需要手动操作和备份）
- 集成测试和API测试（可选）
- 更新API文档和数据库设计文档

**规格说明文档:** `doc/服务分类重构-规格说明.md`

**下一步:** 
1. 备份数据库
2. 执行迁移脚本：`server/sql/wedding/017_simplify_service_category.sql`
3. 验证功能正常
4. 如有问题，执行回滚脚本：`server/sql/wedding/017_rollback_simplify_service_category.sql`
