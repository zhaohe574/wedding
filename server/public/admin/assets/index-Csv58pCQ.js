import{l as Ve,m as xe,D as Se,B as Ee,C as Be,J as De,K as Ue,V as $e,i as Le,H as ze,G as Me,I as Te,L as Ne,M as Fe,q as Pe,N as Ye,O as je,P as Ie,R as Oe,h as Re,a as V,E as v}from"./element-plus-ChK2e5qA.js";import{x as qe,y as Ae,z as He,A as Je,B as Ke,C as Ge,D as Qe,E as We,F as Xe,G as Ze,H as et,I as tt,J as at,K as lt}from"./financial-BtVBj2RS.js";import{d as st,r as c,a0 as K,w as nt,l as ot,c as w,o as i,U as t,P as b,K as g,L as l,T as dt,R as n,a as u,S as d,M as G}from"./@vue-ygbFPFRc.js";import{d as it}from"./index-D465kfFn.js";import"./@element-plus-C4Lf8veM.js";import"./lodash-es-C1lm3Iro.js";import"./dayjs-Bnps4p3p.js";import"./@popperjs-D_chPuIy.js";import"./async-validator-9PlIezaS.js";import"./@ctrl-r5W6hzzQ.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./nprogress-UhqZPtFR.js";import"./vue-router-Cg6aTb_d.js";import"./pinia-CfRoOCaL.js";import"./axios-DIsA03vz.js";import"./lodash-CMKdTQec.js";import"./@vueuse-yz9uDhpq.js";import"./css-color-function-rr4n3v1N.js";import"./balanced-match-BdS7OldZ.js";import"./color-DYO1E7y4.js";import"./clone-Ddk2tjDh.js";import"./color-convert-DsNsD289.js";import"./color-name-Dju3oUBS.js";import"./color-string-pUQDDJII.js";import"./ms-CzQ2E3wO.js";import"./vue-clipboard3-BWi338pc.js";import"./clipboard-7pJsftR6.js";import"./echarts-DRRUpF4H.js";import"./tslib-BDyQ-Jie.js";import"./zrender-DDSL_IW4.js";import"./highlight.js-BLB-XFKK.js";import"./@highlightjs-DS9t1Xn3.js";const ut={class:"settlement-management"},rt={class:"stat-value"},mt={class:"stat-value text-warning"},pt={class:"stat-value"},_t={class:"stat-value text-success"},ct={class:"flex justify-between"},ft={key:0,class:"flex items-center"},gt={class:"text-primary font-bold"},bt={class:"flex justify-end mt-4"},yt={class:"flex justify-between"},vt={class:"text-success"},kt={class:"text-danger"},wt={class:"flex justify-between"},Ct={key:0},ht={key:1},Vt={key:0},xt={key:1},St={key:1,class:"text-muted"},Et=st({__name:"index",setup(Bt){const x=c("records"),F=c(!1),Q=c([]),W=c(0),P=c([]),S=c([]),U=c({}),Y=c(!1),X=c([]),$=c(!1),E=c([]),y=K({batch_name:"",remark:""}),j=c(!1),Z=c([]),B=c(!1),m=K({id:0,settlement_rate:70,min_amount:0,settle_cycle:1,settle_delay_days:7,remark:""}),r=K({page_no:1,page_size:15,staff_name:"",order_sn:"",status:"",start_date:"",end_date:""}),C=s=>(Number(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),se=s=>({0:"warning",1:"success",2:"info",3:"danger"})[s]||"",ne=s=>({0:"warning",1:"primary",2:"info",3:"success",4:"danger"})[s]||"",oe=s=>{r.start_date=(s==null?void 0:s[0])||"",r.end_date=(s==null?void 0:s[1])||""},de=s=>{S.value=s.map(e=>e.id)},I=()=>{r.page_no=1,D(),T()},ie=()=>{Object.assign(r,{staff_name:"",order_sn:"",status:"",start_date:"",end_date:""}),P.value=[],I()},D=async()=>{F.value=!0;try{const s=await qe(r);Q.value=s.lists||[],W.value=s.count||0}finally{F.value=!1}},T=async()=>{const s=await Ae({start_date:r.start_date,end_date:r.end_date});U.value=s||{}},ue=async s=>{const e=await He({id:s.id});V.alert(JSON.stringify(e,null,2),"结算详情",{dangerouslyUseHTMLString:!1})},re=async s=>{var e;await V.confirm(`确定结算 ¥${C(s.actual_amount)} 给 ${(e=s.staff)==null?void 0:e.name}？`,"确认结算"),await Je({id:s.id}),v.success("结算成功"),D(),T()},me=async()=>{await V.confirm(`确定批量结算选中的 ${S.value.length} 条记录？`,"批量结算");const s=await Ke({ids:S.value});v.success(`成功 ${s.success_count} 条，失败 ${s.fail_count} 条`),S.value=[],D(),T()},L=async()=>{Y.value=!0;try{const s=await Ge({});X.value=s.lists||[]}finally{Y.value=!1}},pe=()=>{y.batch_name="",y.remark="",E.value=[],$.value=!0},_e=async()=>{var s;if(!((s=E.value)!=null&&s.length)){v.warning("请选择结算周期");return}await Qe({batch_name:y.batch_name,settle_start_date:E.value[0],settle_end_date:E.value[1],remark:y.remark}),v.success("创建成功"),$.value=!1,L()},ee=async(s,e)=>{const z=e===1?"通过":"拒绝";await V.confirm(`确定${z}该批次？`,"审核确认"),await We({batch_id:s.id,status:e}),v.success("操作成功"),L()},ce=async s=>{await V.confirm("确定执行该批次结算？","执行确认");const e=await Xe({id:s.id});v.success(`执行完成：成功 ${e.success_count} 条，失败 ${e.fail_count} 条`),L()},fe=async s=>{await V.confirm("确定取消该批次？","取消确认"),await Ze({id:s.id}),v.success("取消成功"),L()},O=async()=>{j.value=!0;try{const s=await et();Z.value=s||[]}finally{j.value=!1}},ge=()=>{Object.assign(m,{id:0,settlement_rate:70,min_amount:0,settle_cycle:1,settle_delay_days:7,remark:""}),B.value=!0},be=s=>{Object.assign(m,s),B.value=!0},ye=async()=>{m.id?await tt(m):await at(m),v.success("保存成功"),B.value=!1,O()},ve=async s=>{await V.confirm("确定删除该配置？","删除确认"),await lt({id:s.id}),v.success("删除成功"),O()};return nt(x,s=>{s==="records"?D():s==="batch"?L():s==="config"&&O()}),ot(()=>{D(),T()}),(s,e)=>{const z=Ve,ke=xe,M=Be,f=Ee,h=Ue,te=De,ae=$e,p=Le,R=Se,k=ze,N=Me,we=Te,o=Fe,Ce=Pe,q=Ye,A=Ne,he=Ie,le=Oe,H=Re,J=je;return i(),w("div",ut,[t(ke,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=a=>x.value=a),class:"mb-4"},{default:l(()=>[t(z,{label:"结算记录",name:"records"}),t(z,{label:"结算批次",name:"batch"}),t(z,{label:"结算配置",name:"config"})]),_:1},8,["modelValue"]),x.value==="records"?(i(),w(dt,{key:0},[t(k,{class:"!border-none mb-4",shadow:"never"},{default:l(()=>[t(R,{model:r,inline:""},{default:l(()=>[t(f,{label:"服务人员"},{default:l(()=>[t(M,{modelValue:r.staff_name,"onUpdate:modelValue":e[1]||(e[1]=a=>r.staff_name=a),placeholder:"人员姓名",clearable:""},null,8,["modelValue"])]),_:1}),t(f,{label:"订单编号"},{default:l(()=>[t(M,{modelValue:r.order_sn,"onUpdate:modelValue":e[2]||(e[2]=a=>r.order_sn=a),placeholder:"订单编号",clearable:""},null,8,["modelValue"])]),_:1}),t(f,{label:"状态"},{default:l(()=>[t(te,{modelValue:r.status,"onUpdate:modelValue":e[3]||(e[3]=a=>r.status=a),placeholder:"全部",clearable:""},{default:l(()=>[t(h,{label:"待结算",value:0}),t(h,{label:"已结算",value:1}),t(h,{label:"已取消",value:2}),t(h,{label:"结算失败",value:3})]),_:1},8,["modelValue"])]),_:1}),t(f,{label:"服务日期"},{default:l(()=>[t(ae,{modelValue:P.value,"onUpdate:modelValue":e[4]||(e[4]=a=>P.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始","end-placeholder":"结束","value-format":"YYYY-MM-DD",onChange:oe},null,8,["modelValue"])]),_:1}),t(f,null,{default:l(()=>[t(p,{type:"primary",onClick:I},{default:l(()=>e[19]||(e[19]=[n("查询")])),_:1}),t(p,{onClick:ie},{default:l(()=>e[20]||(e[20]=[n("重置")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(we,{gutter:16,class:"mb-4"},{default:l(()=>[t(N,{span:6},{default:l(()=>[t(k,{class:"stat-card",shadow:"never"},{default:l(()=>[e[21]||(e[21]=u("div",{class:"stat-label"},"待结算笔数",-1)),u("div",rt,d(U.value.pending_count),1)]),_:1})]),_:1}),t(N,{span:6},{default:l(()=>[t(k,{class:"stat-card",shadow:"never"},{default:l(()=>[e[22]||(e[22]=u("div",{class:"stat-label"},"待结算金额",-1)),u("div",mt,"¥"+d(C(U.value.pending_amount)),1)]),_:1})]),_:1}),t(N,{span:6},{default:l(()=>[t(k,{class:"stat-card",shadow:"never"},{default:l(()=>[e[23]||(e[23]=u("div",{class:"stat-label"},"已结算笔数",-1)),u("div",pt,d(U.value.settled_count),1)]),_:1})]),_:1}),t(N,{span:6},{default:l(()=>[t(k,{class:"stat-card",shadow:"never"},{default:l(()=>[e[24]||(e[24]=u("div",{class:"stat-label"},"已结算金额",-1)),u("div",_t,"¥"+d(C(U.value.settled_amount)),1)]),_:1})]),_:1})]),_:1}),t(k,{class:"!border-none",shadow:"never"},{header:l(()=>[u("div",ct,[e[25]||(e[25]=u("span",null,"结算记录",-1)),t(p,{type:"primary",disabled:!S.value.length,onClick:me},{default:l(()=>[n(" 批量结算 ("+d(S.value.length)+") ",1)]),_:1},8,["disabled"])])]),default:l(()=>[G((i(),g(A,{data:Q.value,onSelectionChange:de},{default:l(()=>[t(o,{type:"selection",width:"50",selectable:a=>a.status===0},null,8,["selectable"]),t(o,{prop:"settlement_sn",label:"结算编号","min-width":"150"}),t(o,{label:"服务人员",width:"120"},{default:l(({row:a})=>[a.staff?(i(),w("div",ft,[t(Ce,{src:a.staff.avatar,size:28,class:"mr-2"},null,8,["src"]),n(" "+d(a.staff.name),1)])):b("",!0)]),_:1}),t(o,{label:"订单编号",width:"140"},{default:l(({row:a})=>{var _;return[n(d(((_=a.order)==null?void 0:_.order_sn)||"-"),1)]}),_:1}),t(o,{prop:"service_date",label:"服务日期",width:"110"}),t(o,{prop:"order_amount",label:"订单金额",width:"100",align:"right"},{default:l(({row:a})=>[n("¥"+d(C(a.order_amount)),1)]),_:1}),t(o,{prop:"settlement_rate",label:"结算比例",width:"90",align:"center"},{default:l(({row:a})=>[n(d(a.settlement_rate)+"%",1)]),_:1}),t(o,{prop:"actual_amount",label:"结算金额",width:"100",align:"right"},{default:l(({row:a})=>[u("span",gt,"¥"+d(C(a.actual_amount)),1)]),_:1}),t(o,{prop:"status",label:"状态",width:"90"},{default:l(({row:a})=>[t(q,{type:se(a.status)},{default:l(()=>[n(d(a.status_text),1)]),_:2},1032,["type"])]),_:1}),t(o,{label:"操作",width:"120",fixed:"right"},{default:l(({row:a})=>[t(p,{type:"primary",link:"",onClick:_=>ue(a)},{default:l(()=>e[26]||(e[26]=[n("详情")])),_:2},1032,["onClick"]),a.status===0?(i(),g(p,{key:0,type:"success",link:"",onClick:_=>re(a)},{default:l(()=>e[27]||(e[27]=[n("结算")])),_:2},1032,["onClick"])):b("",!0)]),_:1})]),_:1},8,["data"])),[[J,F.value]]),u("div",bt,[t(he,{"current-page":r.page_no,"onUpdate:currentPage":e[5]||(e[5]=a=>r.page_no=a),"page-size":r.page_size,"onUpdate:pageSize":e[6]||(e[6]=a=>r.page_size=a),total:W.value,"page-sizes":[15,30,50],layout:"total, sizes, prev, pager, next",onSizeChange:I,onCurrentChange:D},null,8,["current-page","page-size","total"])])]),_:1})],64)):b("",!0),x.value==="batch"?(i(),g(k,{key:1,class:"!border-none",shadow:"never"},{header:l(()=>[u("div",yt,[e[29]||(e[29]=u("span",null,"结算批次",-1)),t(p,{type:"primary",onClick:pe},{default:l(()=>e[28]||(e[28]=[n("创建批次")])),_:1})])]),default:l(()=>[G((i(),g(A,{data:X.value},{default:l(()=>[t(o,{prop:"batch_sn",label:"批次编号",width:"160"}),t(o,{prop:"batch_name",label:"批次名称","min-width":"150"}),t(o,{label:"结算周期",width:"200"},{default:l(({row:a})=>[n(d(a.settle_start_date)+" ~ "+d(a.settle_end_date),1)]),_:1}),t(o,{prop:"total_count",label:"总笔数",width:"80",align:"center"}),t(o,{prop:"total_amount",label:"总金额",width:"120",align:"right"},{default:l(({row:a})=>[n("¥"+d(C(a.total_amount)),1)]),_:1}),t(o,{prop:"success_count",label:"成功/失败",width:"100",align:"center"},{default:l(({row:a})=>[u("span",vt,d(a.success_count),1),e[30]||(e[30]=n(" / ")),u("span",kt,d(a.fail_count),1)]),_:1}),t(o,{prop:"status",label:"状态",width:"90"},{default:l(({row:a})=>[t(q,{type:ne(a.status)},{default:l(()=>[n(d(a.status_text),1)]),_:2},1032,["type"])]),_:1}),t(o,{prop:"create_time",label:"创建时间",width:"170"}),t(o,{label:"操作",width:"180",fixed:"right"},{default:l(({row:a})=>[a.status===0?(i(),g(p,{key:0,type:"success",link:"",onClick:_=>ee(a,1)},{default:l(()=>e[31]||(e[31]=[n("通过")])),_:2},1032,["onClick"])):b("",!0),a.status===0?(i(),g(p,{key:1,type:"danger",link:"",onClick:_=>ee(a,2)},{default:l(()=>e[32]||(e[32]=[n("拒绝")])),_:2},1032,["onClick"])):b("",!0),a.status===1?(i(),g(p,{key:2,type:"primary",link:"",onClick:_=>ce(a)},{default:l(()=>e[33]||(e[33]=[n("执行")])),_:2},1032,["onClick"])):b("",!0),[0,1].includes(a.status)?(i(),g(p,{key:3,type:"warning",link:"",onClick:_=>fe(a)},{default:l(()=>e[34]||(e[34]=[n("取消")])),_:2},1032,["onClick"])):b("",!0)]),_:1})]),_:1},8,["data"])),[[J,Y.value]])]),_:1})):b("",!0),x.value==="config"?(i(),g(k,{key:2,class:"!border-none",shadow:"never"},{header:l(()=>[u("div",wt,[e[36]||(e[36]=u("span",null,"结算配置",-1)),t(p,{type:"primary",onClick:ge},{default:l(()=>e[35]||(e[35]=[n("添加配置")])),_:1})])]),default:l(()=>[G((i(),g(A,{data:Z.value},{default:l(()=>[t(o,{label:"适用人员",width:"120"},{default:l(({row:a})=>{var _;return[a.staff_id===0?(i(),w("span",Ct,"全部人员")):(i(),w("span",ht,d(((_=a.staff)==null?void 0:_.name)||"-"),1))]}),_:1}),t(o,{label:"适用分类",width:"120"},{default:l(({row:a})=>{var _;return[a.category_id===0?(i(),w("span",Vt,"全部分类")):(i(),w("span",xt,d(((_=a.category)==null?void 0:_.name)||"-"),1))]}),_:1}),t(o,{prop:"settlement_rate",label:"结算比例",width:"100",align:"center"},{default:l(({row:a})=>[n(d(a.settlement_rate)+"%",1)]),_:1}),t(o,{prop:"min_amount",label:"最低金额",width:"100",align:"right"},{default:l(({row:a})=>[n("¥"+d(C(a.min_amount)),1)]),_:1}),t(o,{prop:"cycle_text",label:"结算周期",width:"90"}),t(o,{prop:"settle_delay_days",label:"延迟天数",width:"90",align:"center"},{default:l(({row:a})=>[n(d(a.settle_delay_days)+" 天",1)]),_:1}),t(o,{prop:"is_default",label:"默认配置",width:"90",align:"center"},{default:l(({row:a})=>[a.is_default?(i(),g(q,{key:0,type:"success"},{default:l(()=>e[37]||(e[37]=[n("是")])),_:1})):(i(),w("span",St,"否"))]),_:1}),t(o,{prop:"status_text",label:"状态",width:"80"}),t(o,{prop:"remark",label:"备注","min-width":"150","show-overflow-tooltip":""}),t(o,{label:"操作",width:"120",fixed:"right"},{default:l(({row:a})=>[t(p,{type:"primary",link:"",onClick:_=>be(a)},{default:l(()=>e[38]||(e[38]=[n("编辑")])),_:2},1032,["onClick"]),a.is_default?b("",!0):(i(),g(p,{key:0,type:"danger",link:"",onClick:_=>ve(a)},{default:l(()=>e[39]||(e[39]=[n("删除")])),_:2},1032,["onClick"]))]),_:1})]),_:1},8,["data"])),[[J,j.value]])]),_:1})):b("",!0),t(le,{modelValue:$.value,"onUpdate:modelValue":e[11]||(e[11]=a=>$.value=a),title:"创建结算批次",width:"500px"},{footer:l(()=>[t(p,{onClick:e[10]||(e[10]=a=>$.value=!1)},{default:l(()=>e[40]||(e[40]=[n("取消")])),_:1}),t(p,{type:"primary",onClick:_e},{default:l(()=>e[41]||(e[41]=[n("确定")])),_:1})]),default:l(()=>[t(R,{model:y,"label-width":"100px"},{default:l(()=>[t(f,{label:"批次名称"},{default:l(()=>[t(M,{modelValue:y.batch_name,"onUpdate:modelValue":e[7]||(e[7]=a=>y.batch_name=a),placeholder:"可选，默认自动生成"},null,8,["modelValue"])]),_:1}),t(f,{label:"结算周期",required:""},{default:l(()=>[t(ae,{modelValue:E.value,"onUpdate:modelValue":e[8]||(e[8]=a=>E.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(f,{label:"备注"},{default:l(()=>[t(M,{modelValue:y.remark,"onUpdate:modelValue":e[9]||(e[9]=a=>y.remark=a),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(le,{modelValue:B.value,"onUpdate:modelValue":e[18]||(e[18]=a=>B.value=a),title:m.id?"编辑配置":"添加配置",width:"500px"},{footer:l(()=>[t(p,{onClick:e[17]||(e[17]=a=>B.value=!1)},{default:l(()=>e[44]||(e[44]=[n("取消")])),_:1}),t(p,{type:"primary",onClick:ye},{default:l(()=>e[45]||(e[45]=[n("保存")])),_:1})]),default:l(()=>[t(R,{model:m,"label-width":"100px"},{default:l(()=>[t(f,{label:"结算比例",required:""},{default:l(()=>[t(H,{modelValue:m.settlement_rate,"onUpdate:modelValue":e[12]||(e[12]=a=>m.settlement_rate=a),min:0,max:100,precision:2},null,8,["modelValue"]),e[42]||(e[42]=u("span",{class:"ml-2"},"%",-1))]),_:1}),t(f,{label:"最低金额"},{default:l(()=>[t(H,{modelValue:m.min_amount,"onUpdate:modelValue":e[13]||(e[13]=a=>m.min_amount=a),min:0,precision:2},null,8,["modelValue"])]),_:1}),t(f,{label:"结算周期"},{default:l(()=>[t(te,{modelValue:m.settle_cycle,"onUpdate:modelValue":e[14]||(e[14]=a=>m.settle_cycle=a)},{default:l(()=>[t(h,{label:"月结",value:1}),t(h,{label:"周结",value:2}),t(h,{label:"单笔结",value:3})]),_:1},8,["modelValue"])]),_:1}),t(f,{label:"延迟天数"},{default:l(()=>[t(H,{modelValue:m.settle_delay_days,"onUpdate:modelValue":e[15]||(e[15]=a=>m.settle_delay_days=a),min:0},null,8,["modelValue"]),e[43]||(e[43]=u("span",{class:"ml-2"},"天",-1))]),_:1}),t(f,{label:"备注"},{default:l(()=>[t(M,{modelValue:m.remark,"onUpdate:modelValue":e[16]||(e[16]=a=>m.remark=a),type:"textarea",rows:"2"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),da=it(Et,[["__scopeId","data-v-e9916e6f"]]);export{da as default};
