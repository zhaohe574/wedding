import{d as a,s as e,M as l,c as t,v as s,O as c,o as u,h as i,e as r,w as f,g as d,b as o,j as n,t as _,f as m,y as v,F as p,i as g,aP as y,aq as h,aD as k,aV as x,b5 as b,r as w,a as C,m as z,G as j,l as F,a_ as V,b0 as P,aJ as $,I as T}from"./index-e3492752.js";import{_ as I}from"./navigation-bar.2687311c.js";import{_ as M}from"./page-meta.a4be6114.js";import{h as N,p as U}from"./orderChange.66dcaaa9.js";import{e as q}from"./order.1e435880.js";import{g as B,a as D}from"./staff.2454008a.js";import{_ as G}from"./_plugin-vue_export-helper.1b428a4d.js";const J=G(a({__name:"apply_staff",setup(a){const G=e(0),J=e(0),O=e(null),S=e(null),Y=e(!1),A=e([]),E=e([]),H=e(null),K=e(null),L=e(!1),Q=e(!1),R=l({reason:"",attach_images:[]}),W=e(),X=e(),Z=t((()=>S.value?A.value.filter((a=>a.id!==S.value.staff_id)):A.value)),aa=t((()=>K.value&&K.value.price||0)),ea=t((()=>S.value&&K.value?aa.value-S.value.price:0)),la=t((()=>H.value&&K.value)),ta=a=>{var e;H.value=a,K.value=null,E.value=[],(async a=>{try{const e=await D({staff_id:a});E.value=e.lists||e||[]}catch(e){console.error(e)}})(a.id),null==(e=W.value)||e.close()},sa=()=>{x({count:5-R.attach_images.length,sizeType:["compressed"],sourceType:["album","camera"],success:a=>{R.attach_images.push(...a.tempFilePaths)}})},ca=async()=>{if(la.value){Y.value=!0;try{const a={order_id:G.value,item_id:J.value,new_staff_id:H.value.id,new_package_id:K.value.id,reason:R.reason,attach_images:R.attach_images},e=await U(a);k({title:"申请已提交"}),setTimeout((()=>{b({url:`/pages/order_change/change_detail?id=${e.change_id}`})}),1500)}catch(a){k({title:a.message||"提交失败",icon:"none"})}finally{Y.value=!1}}else k({title:"请选择新服务人员和套餐",icon:"none"})};return s((()=>L.value),(a=>{var e;a&&(null==(e=W.value)||e.open())})),s((()=>Q.value),(a=>{var e;a&&(null==(e=X.value)||e.open())})),c((a=>{a.order_id&&(G.value=Number(a.order_id)),a.item_id&&(J.value=Number(a.item_id)),(async()=>{try{const a=await q({id:G.value});O.value=a,a.items&&J.value?S.value=a.items.find((a=>a.id===J.value)):a.items&&a.items.length>0&&(S.value=a.items[0],J.value=S.value.id)}catch(a){console.error(a)}})(),(async()=>{try{const a=await N({order_id:G.value});a.can_change||y({title:"提示",content:a.message,showCancel:!1,success:()=>{h()}})}catch(a){k({title:a.message||"检查失败",icon:"none"})}})(),(async()=>{try{const a=await B({page:1,limit:100});A.value=a.lists||a||[]}catch(a){console.error(a)}})()})),(a,e)=>{const l=w(C("navigation-bar"),I),t=w(C("page-meta"),M),s=z,c=j,y=F,h=V("uni-icons"),k=P,x=$,b=T,N=V("uni-popup");return u(),i(p,null,[r(t,{"page-style":a.$theme.pageStyle},{default:f((()=>[r(l,{title:"换人申请","front-color":a.$theme.navColor,"background-color":a.$theme.navBgColor},null,8,["front-color","background-color"])])),_:1},8,["page-style"]),r(s,{class:"apply-page"},{default:f((()=>[d(" 订单信息 "),O.value?(u(),o(s,{key:0,class:"bg-white p-4"},{default:f((()=>[r(s,{class:"section-title"},{default:f((()=>[n("当前订单")])),_:1}),r(s,{class:"order-card"},{default:f((()=>[r(s,{class:"text-sm text-gray-500"},{default:f((()=>[n("订单号: "+_(O.value.order_sn),1)])),_:1}),r(s,{class:"mt-2 text-sm text-gray-500"},{default:f((()=>[n(" 服务日期: "+_(O.value.service_date),1)])),_:1})])),_:1})])),_:1})):d("v-if",!0),d(" 当前人员 "),S.value?(u(),o(s,{key:1,class:"bg-white mt-3 p-4"},{default:f((()=>[r(s,{class:"section-title"},{default:f((()=>[n("当前服务人员")])),_:1}),r(s,{class:"staff-card current"},{default:f((()=>{var a;return[r(c,{src:(null==(a=S.value.staff)?void 0:a.avatar)||"/static/images/default-avatar.png",class:"staff-avatar",mode:"aspectFill"},null,8,["src"]),r(s,{class:"staff-info"},{default:f((()=>[r(s,{class:"staff-name"},{default:f((()=>[n(_(S.value.staff_name),1)])),_:1}),r(s,{class:"staff-package"},{default:f((()=>[n(_(S.value.package_name),1)])),_:1}),r(s,{class:"staff-price"},{default:f((()=>[n("¥"+_(S.value.price),1)])),_:1})])),_:1}),r(s,{class:"current-tag"},{default:f((()=>[n("当前")])),_:1})]})),_:1})])),_:1})):d("v-if",!0),d(" 选择新人员 "),r(s,{class:"bg-white mt-3 p-4"},{default:f((()=>[r(s,{class:"section-title"},{default:f((()=>[n("选择新服务人员")])),_:1}),r(s,{class:"form-item",onClick:e[0]||(e[0]=a=>L.value=!0)},{default:f((()=>[r(y,{class:"label"},{default:f((()=>[n("新人员")])),_:1}),r(s,{class:"value-area"},{default:f((()=>[H.value?(u(),o(y,{key:0,class:"text-primary"},{default:f((()=>[n(_(H.value.name),1)])),_:1})):(u(),o(y,{key:1,class:"placeholder"},{default:f((()=>[n("请选择要更换的服务人员")])),_:1})),r(h,{type:"right",size:"16",color:"#999"})])),_:1})])),_:1}),d(" 新人员信息展示 "),H.value?(u(),o(s,{key:0,class:"staff-card new mt-3"},{default:f((()=>[r(c,{src:H.value.avatar||"/static/images/default-avatar.png",class:"staff-avatar",mode:"aspectFill"},null,8,["src"]),r(s,{class:"staff-info"},{default:f((()=>[r(s,{class:"staff-name"},{default:f((()=>[n(_(H.value.name),1)])),_:1}),r(s,{class:"staff-level"},{default:f((()=>[n(_(H.value.level_name||"普通级别"),1)])),_:1}),r(s,{class:"flex items-center mt-1"},{default:f((()=>[r(h,{type:"star-filled",size:"14",color:"#ffc107"}),r(y,{class:"text-xs text-yellow-500 ml-1"},{default:f((()=>[n(_(H.value.score||"5.0"),1)])),_:1})])),_:1})])),_:1}),r(s,{class:"new-tag"},{default:f((()=>[n("新")])),_:1})])),_:1})):d("v-if",!0),d(" 选择套餐 "),H.value?(u(),o(s,{key:1,class:"form-item mt-3",onClick:e[1]||(e[1]=a=>Q.value=!0)},{default:f((()=>[r(y,{class:"label"},{default:f((()=>[n("服务套餐")])),_:1}),r(s,{class:"value-area"},{default:f((()=>[K.value?(u(),o(y,{key:0,class:"text-primary"},{default:f((()=>[n(_(K.value.name),1)])),_:1})):(u(),o(y,{key:1,class:"placeholder"},{default:f((()=>[n("请选择套餐")])),_:1})),r(h,{type:"right",size:"16",color:"#999"})])),_:1})])),_:1})):d("v-if",!0)])),_:1}),d(" 价格对比 "),H.value&&K.value&&S.value?(u(),o(s,{key:2,class:"bg-white mt-3 p-4"},{default:f((()=>[r(s,{class:"section-title"},{default:f((()=>[n("价格对比")])),_:1}),r(s,{class:"price-compare"},{default:f((()=>[r(s,{class:"price-row"},{default:f((()=>[r(y,{class:"text-sm text-gray-500"},{default:f((()=>[n("原服务价格")])),_:1}),r(y,{class:"text-sm"},{default:f((()=>[n("¥"+_(S.value.price),1)])),_:1})])),_:1}),r(s,{class:"price-row"},{default:f((()=>[r(y,{class:"text-sm text-gray-500"},{default:f((()=>[n("新服务价格")])),_:1}),r(y,{class:"text-sm"},{default:f((()=>[n("¥"+_(m(aa)),1)])),_:1})])),_:1}),r(s,{class:v(["price-row diff",{positive:m(ea)>0,negative:m(ea)<0}])},{default:f((()=>[r(y,{class:"text-sm font-medium"},{default:f((()=>[n("价格差额")])),_:1}),r(y,{class:"text-lg font-bold"},{default:f((()=>[n(_(m(ea)>0?"+":"")+"¥"+_(m(ea)),1)])),_:1})])),_:1},8,["class"])])),_:1}),m(ea)>0?(u(),o(s,{key:0,class:"tip-box mt-3"},{default:f((()=>[r(h,{type:"info",size:"14",color:"#ff9800"}),r(y,{class:"text-xs text-orange-500 ml-1"},{default:f((()=>[n("换人后需补差价 ¥"+_(m(ea)),1)])),_:1})])),_:1})):m(ea)<0?(u(),o(s,{key:1,class:"tip-box success mt-3"},{default:f((()=>[r(h,{type:"info",size:"14",color:"#4caf50"}),r(y,{class:"text-xs text-green-500 ml-1"},{default:f((()=>[n("换人后可退差价 ¥"+_(Math.abs(m(ea))),1)])),_:1})])),_:1})):d("v-if",!0)])),_:1})):d("v-if",!0),d(" 申请原因 "),r(s,{class:"bg-white mt-3 p-4"},{default:f((()=>[r(s,{class:"section-title"},{default:f((()=>[n("申请原因")])),_:1}),r(k,{modelValue:R.reason,"onUpdate:modelValue":e[2]||(e[2]=a=>R.reason=a),class:"reason-input",placeholder:"请填写换人原因（选填）",maxlength:"200"},null,8,["modelValue"]),r(s,{class:"text-right text-xs text-gray-400"},{default:f((()=>[n(_(R.reason.length)+"/200",1)])),_:1})])),_:1}),d(" 附件图片 "),r(s,{class:"bg-white mt-3 p-4"},{default:f((()=>[r(s,{class:"section-title"},{default:f((()=>[n("附件图片（选填）")])),_:1}),r(s,{class:"image-uploader"},{default:f((()=>[(u(!0),i(p,null,g(R.attach_images,((a,e)=>(u(),o(s,{key:e,class:"image-item"},{default:f((()=>[r(c,{src:a,class:"upload-image",mode:"aspectFill"},null,8,["src"]),r(s,{class:"delete-btn",onClick:a=>(a=>{R.attach_images.splice(a,1)})(e)},{default:f((()=>[r(h,{type:"close",size:"14",color:"#fff"})])),_:2},1032,["onClick"])])),_:2},1024)))),128)),R.attach_images.length<5?(u(),o(s,{key:0,class:"add-image",onClick:sa},{default:f((()=>[r(h,{type:"plusempty",size:"40",color:"#ccc"}),r(y,{class:"text-xs text-gray-400 mt-1"},{default:f((()=>[n("上传图片")])),_:1})])),_:1})):d("v-if",!0)])),_:1}),r(s,{class:"text-xs text-gray-400 mt-2"},{default:f((()=>[n("最多上传5张图片，支持jpg、png格式")])),_:1})])),_:1}),d(" 提交按钮 "),r(s,{class:"bottom-actions"},{default:f((()=>[r(x,{class:"btn-submit",disabled:Y.value||!m(la),onClick:ca},{default:f((()=>[n(_(Y.value?"提交中...":"提交申请"),1)])),_:1},8,["disabled"])])),_:1}),d(" 人员选择弹窗 "),r(N,{ref_key:"staffPopup",ref:W,type:"bottom","safe-area":!1},{default:f((()=>[r(s,{class:"picker-popup"},{default:f((()=>[r(s,{class:"picker-header"},{default:f((()=>[r(y,{class:"cancel",onClick:e[3]||(e[3]=a=>{var e;return null==(e=W.value)?void 0:e.close()})},{default:f((()=>[n("取消")])),_:1}),r(y,{class:"title"},{default:f((()=>[n("选择人员")])),_:1}),r(y,{class:"placeholder-btn"})])),_:1}),r(b,{class:"picker-list","scroll-y":""},{default:f((()=>[(u(!0),i(p,null,g(m(Z),(a=>{var e;return u(),o(s,{key:a.id,class:v(["picker-item-card",{active:(null==(e=H.value)?void 0:e.id)===a.id}]),onClick:e=>ta(a)},{default:f((()=>{var e;return[r(c,{src:a.avatar||"/static/images/default-avatar.png",class:"item-avatar",mode:"aspectFill"},null,8,["src"]),r(s,{class:"item-info"},{default:f((()=>[r(s,{class:"item-name"},{default:f((()=>[n(_(a.name),1)])),_:2},1024),r(s,{class:"item-desc"},{default:f((()=>[n(_(a.level_name||"普通级别"),1)])),_:2},1024),r(s,{class:"flex items-center mt-1"},{default:f((()=>[r(h,{type:"star-filled",size:"12",color:"#ffc107"}),r(y,{class:"text-xs text-yellow-500 ml-1"},{default:f((()=>[n(_(a.score||"5.0"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),(null==(e=H.value)?void 0:e.id)===a.id?(u(),o(h,{key:0,type:"checkmarkempty",size:"20",color:"#ff6b35"})):d("v-if",!0)]})),_:2},1032,["class","onClick"])})),128)),0===m(Z).length?(u(),o(s,{key:0,class:"empty-tip"},{default:f((()=>[r(y,null,{default:f((()=>[n("暂无可选人员")])),_:1})])),_:1})):d("v-if",!0)])),_:1})])),_:1})])),_:1},512),d(" 套餐选择弹窗 "),r(N,{ref_key:"packagePopup",ref:X,type:"bottom","safe-area":!1},{default:f((()=>[r(s,{class:"picker-popup"},{default:f((()=>[r(s,{class:"picker-header"},{default:f((()=>[r(y,{class:"cancel",onClick:e[4]||(e[4]=a=>{var e;return null==(e=X.value)?void 0:e.close()})},{default:f((()=>[n("取消")])),_:1}),r(y,{class:"title"},{default:f((()=>[n("选择套餐")])),_:1}),r(y,{class:"placeholder-btn"})])),_:1}),r(b,{class:"picker-list","scroll-y":""},{default:f((()=>[(u(!0),i(p,null,g(E.value,(a=>{var e;return u(),o(s,{key:a.id,class:v(["picker-item-card",{active:(null==(e=K.value)?void 0:e.id)===a.id}]),onClick:e=>(a=>{var e;K.value=a,null==(e=X.value)||e.close()})(a)},{default:f((()=>{var e;return[r(s,{class:"item-info flex-1"},{default:f((()=>[r(s,{class:"item-name"},{default:f((()=>[n(_(a.name),1)])),_:2},1024),r(s,{class:"item-desc"},{default:f((()=>[n(_(a.description),1)])),_:2},1024),r(s,{class:"item-price"},{default:f((()=>[n("¥"+_(a.price),1)])),_:2},1024)])),_:2},1024),(null==(e=K.value)?void 0:e.id)===a.id?(u(),o(h,{key:0,type:"checkmarkempty",size:"20",color:"#ff6b35"})):d("v-if",!0)]})),_:2},1032,["class","onClick"])})),128)),0===E.value.length?(u(),o(s,{key:0,class:"empty-tip"},{default:f((()=>[r(y,null,{default:f((()=>[n("暂无可选套餐")])),_:1})])),_:1})):d("v-if",!0)])),_:1})])),_:1})])),_:1},512)])),_:1})],64)}}}),[["__scopeId","data-v-fc611afc"]]);export{J as default};
