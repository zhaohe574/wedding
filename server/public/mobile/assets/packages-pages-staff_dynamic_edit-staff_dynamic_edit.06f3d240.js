import{d as e,s as l,M as a,c as t,O as s,o as i,h as o,e as n,w as r,f as c,j as u,t as m,b as d,F as p,i as f,g,au as y,y as x,aV as _,af as v,aW as b,aD as h,ag as w,b3 as k,aq as j,r as C,a as V,b0 as z,m as F,l as T,a$ as $,aJ as N,V as q,G as A}from"./index-e3492752.js";import{_ as D}from"./navigation-bar.2687311c.js";import{_ as O}from"./page-meta.a4be6114.js";import{_ as P}from"./icon.e613abcd.js";import{_ as U}from"./u-switch.863c6ebe.js";import{e as B,p as E,q as G}from"./staff-center.563e3f5c.js";import"./_plugin-vue_export-helper.1b428a4d.js";import"./index.f1be293a.js";const J=e({__name:"staff_dynamic_edit",setup(e){const J=[{label:"图文",value:1},{label:"视频",value:2},{label:"案例",value:3},{label:"活动",value:4}],M=l(!1),S=a({id:0,dynamic_type:1,content:"",images:[],video_url:"",allow_comment:1}),W=t((()=>S.id>0)),H=t((()=>W.value?"编辑动态":"发布动态")),I=t((()=>S.content.trim().length>0)),K=t({get:()=>1===S.allow_comment,set:e=>{S.allow_comment=e?1:0}}),L=()=>{const e=9-S.images.length;_({count:e,sizeType:["compressed"],sourceType:["album","camera"],success:async e=>{v({title:"上传中..."});try{for(const l of e.tempFilePaths){const e=await b(l);(null==e?void 0:e.url)&&S.images.push(e.url)}S.images.length>0&&2===S.dynamic_type&&(S.dynamic_type=1)}catch(l){h({title:(null==l?void 0:l.message)||"上传失败",icon:"none"})}finally{w()}}})},Q=()=>{k({sourceType:["album","camera"],maxDuration:60,compressed:!0,success:async e=>{v({title:"上传中..."});try{const l=await b(e.tempFilePath);(null==l?void 0:l.url)&&(S.video_url=l.url,S.dynamic_type=2)}catch(l){h({title:(null==l?void 0:l.message)||"上传失败",icon:"none"})}finally{w()}}})},R=()=>{S.video_url="",2===S.dynamic_type&&(S.dynamic_type=1)},X=async()=>{if(!I.value||M.value)return;const e={content:S.content.trim(),dynamic_type:S.dynamic_type,allow_comment:S.allow_comment};S.images.length>0&&(e.images=S.images),S.video_url&&(e.video_url=S.video_url),M.value=!0;try{W.value?(await E({...e,id:S.id}),h({title:"保存成功",icon:"success"})):(await G(e),h({title:"发布成功",icon:"success"})),setTimeout((()=>j()),1200)}catch(l){const e="string"==typeof l?l:(null==l?void 0:l.msg)||(null==l?void 0:l.message)||"提交失败";h({title:e,icon:"none"})}finally{M.value=!1}};return s((async e=>{var l,a;if(!(await B()))return;const t=q(),s=null==(a=null==(l=null==t?void 0:t.proxy)?void 0:l.getOpenerEventChannel)?void 0:a.call(l);null==s||s.on("detail",(e=>{(e=>{S.id=Number(e.id||0),S.dynamic_type=Number(e.dynamic_type||1),S.content=e.content||"",S.images=Array.isArray(e.images)?e.images:[],S.video_url=e.video_url||e.video||"",S.allow_comment=e.allow_comment?1:0})(e)})),(null==e?void 0:e.id)&&!S.id&&(S.id=Number(e.id))})),(e,l)=>{const a=C(V("navigation-bar"),D),t=C(V("page-meta"),O),s=z,_=F,v=T,b=A,h=C(V("tn-icon"),P),w=$,k=C(V("u-switch"),U),j=N;return i(),o(p,null,[n(t,{"page-style":e.$theme.pageStyle},{default:r((()=>[n(a,{title:c(H),"front-color":e.$theme.navColor,"background-color":e.$theme.navBgColor},null,8,["title","front-color","background-color"])])),_:1},8,["page-style"]),n(_,{class:"min-h-screen bg-[#f6f6f6] pb-[120rpx]"},{default:r((()=>[n(_,{class:"bg-white p-[24rpx]"},{default:r((()=>[n(s,{modelValue:S.content,"onUpdate:modelValue":l[0]||(l[0]=e=>S.content=e),class:"w-full text-base leading-7",placeholder:"分享你的服务动态...",maxlength:2e3,"auto-height":!0,style:{"min-height":"260rpx"}},null,8,["modelValue"]),n(_,{class:"text-right text-xs text-gray-400 mt-[8rpx]"},{default:r((()=>[u(m(S.content.length)+"/2000 ",1)])),_:1})])),_:1}),n(_,{class:"bg-white mt-[16rpx] p-[24rpx]"},{default:r((()=>[n(_,{class:"flex items-center mb-[12rpx]"},{default:r((()=>[n(v,{class:"text-sm font-medium"},{default:r((()=>[u("添加图片/视频")])),_:1}),n(v,{class:"text-xs text-gray-400 ml-[10rpx]"},{default:r((()=>[u("(图片最多9张，或1个视频)")])),_:1})])),_:1}),S.video_url?g("v-if",!0):(i(),d(_,{key:0,class:"flex flex-wrap gap-[12rpx]"},{default:r((()=>[(i(!0),o(p,null,f(S.images,((e,l)=>(i(),d(_,{key:l,class:"w-[200rpx] h-[200rpx] relative"},{default:r((()=>[n(b,{src:e,class:"w-full h-full rounded",mode:"aspectFill"},null,8,["src"]),n(_,{class:"absolute -top-[8rpx] -right-[8rpx] w-[40rpx] h-[40rpx] bg-black/50 rounded-full flex items-center justify-center",onClick:e=>(e=>{S.images.splice(e,1)})(l)},{default:r((()=>[n(h,{name:"close",size:"24",color:"#fff"})])),_:2},1032,["onClick"])])),_:2},1024)))),128)),S.images.length<9?(i(),d(_,{key:0,class:"w-[200rpx] h-[200rpx] rounded bg-[#f4f4f4] flex items-center justify-center",onClick:L},{default:r((()=>[n(h,{name:"plus",size:"40",color:"#999"})])),_:1})):g("v-if",!0)])),_:1})),0===S.images.length?(i(),d(_,{key:1,class:"mt-[12rpx]"},{default:r((()=>[S.video_url?(i(),d(_,{key:0,class:"relative w-full aspect-video rounded overflow-hidden"},{default:r((()=>[n(w,{src:S.video_url,class:"w-full h-full","object-fit":"cover"},null,8,["src"]),n(_,{class:"absolute top-[12rpx] right-[12rpx] w-[48rpx] h-[48rpx] bg-black/50 rounded-full flex items-center justify-center",onClick:R},{default:r((()=>[n(h,{name:"close",size:"28",color:"#fff"})])),_:1})])),_:1})):(i(),d(_,{key:1,class:"w-[200rpx] h-[200rpx] rounded bg-[#f4f4f4] flex items-center justify-center",onClick:Q},{default:r((()=>[n(h,{name:"play-right",size:"40",color:"#999"})])),_:1}))])),_:1})):g("v-if",!0)])),_:1}),n(_,{class:"bg-white mt-[16rpx] p-[24rpx]"},{default:r((()=>[n(_,{class:"text-sm font-medium mb-[12rpx]"},{default:r((()=>[u("选择类型")])),_:1}),n(_,{class:"flex flex-wrap gap-[12rpx]"},{default:r((()=>[(i(),o(p,null,f(J,(e=>n(_,{key:e.value,class:x(["px-[24rpx] py-[12rpx] rounded-full text-sm",S.dynamic_type===e.value?"bg-primary text-white":"bg-gray-100 text-gray-500"]),onClick:l=>S.dynamic_type=e.value},{default:r((()=>[u(m(e.label),1)])),_:2},1032,["class","onClick"]))),64))])),_:1})])),_:1}),n(_,{class:"bg-white mt-[16rpx] p-[24rpx] flex items-center justify-between"},{default:r((()=>[n(_,{class:"text-sm"},{default:r((()=>[u("允许评论")])),_:1}),n(k,{modelValue:c(K),"onUpdate:modelValue":l[1]||(l[1]=e=>y(K)?K.value=e:null),"active-color":"#16a34a","inactive-color":"#e5e7eb"},null,8,["modelValue"])])),_:1}),n(_,{class:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-[24rpx]",style:{"padding-bottom":"calc(24rpx + env(safe-area-inset-bottom))"}},{default:r((()=>[n(j,{class:x(["w-full py-[18rpx] bg-primary text-white text-base font-medium rounded-full",{"opacity-50":!c(I)||M.value}]),disabled:!c(I)||M.value,onClick:X},{default:r((()=>[u(m(M.value?"提交中...":c(W)?"保存修改":"发布动态"),1)])),_:1},8,["disabled","class"])])),_:1})])),_:1})],64)}}});export{J as default};
