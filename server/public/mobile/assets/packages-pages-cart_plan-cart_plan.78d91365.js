import{d as a,u as e,s as l,P as t,o as s,h as c,e as o,f as r,w as i,g as n,j as u,b as d,n as f,F as _,i as p,t as m,aD as y,a0 as g,k,r as v,a as C,l as h,m as b,aP as F,G as j}from"./index-e3492752.js";import{_ as w}from"./page-meta.a4be6114.js";import{_ as z}from"./icon.e613abcd.js";import{_ as x}from"./popup.b8b85cf1.js";import{h as N,i as $,j as M,k as E,l as A}from"./cart.c9c79b39.js";import{_ as V}from"./_plugin-vue_export-helper.1b428a4d.js";import"./index.f1be293a.js";import"./z-index.5f93cfb9.js";import"./is-boolean.00bf65dc.js";import"./_objectToString.c905654b.js";import"./is-empty.c0d66e4a.js";import"./index.89b6df5d.js";import"./event.5568c9d8.js";import"./install.8446dea8.js";const P=V(a({__name:"cart_plan",setup(a){const V=e(),P=l(!1),S=l([]),q=l(!1),D=l(""),G=l(null),H=l(!1),I=a=>{const e=Number(a||0);return Number.isFinite(e)?e.toFixed(2):"0.00"},J=a=>{const e=[],l=new Map,t={0:"全天",1:"早礼",2:"午宴",3:"晚宴"};return a.forEach(((a,s)=>{var c,o,r,i,n;const u=Number(a.staff_id||(null==(c=a.staff)?void 0:c.id)||0),d=a.staff_name||(null==(o=a.staff)?void 0:o.name)||"",f=a.staff_avatar||(null==(r=a.staff)?void 0:r.avatar)||"",_=a.schedule_date||"",p=`${u}-${_}`;let m=l.get(p);m||(m={key:p,staff_id:u,staff_name:d,staff_avatar:f,schedule_date:_,total_price:0,packages:[],packageMap:new Map},l.set(p,m),e.push(m));const y=Number(a.price||0)*Number(a.quantity||1);m.total_price+=y;const g=Number(a.package_id||(null==(i=a.package)?void 0:i.id)||0),k=a.package_name||(null==(n=a.package)?void 0:n.name)||"",v=`${p}-${g}`;let C=m.packageMap.get(v);C||(C={key:v,package_id:g,package_name:k,total_price:0,items:[]},m.packageMap.set(v,C),m.packages.push(C)),C.total_price+=y;const h=Number(a.time_slot||0),b=a.cart_id||a.id||`${v}-${s}`;C.items.push({...a,_key:b,time_slot_desc:a.time_slot_desc||t[h]||"未知场次"})})),e.forEach((a=>{a.total_price=Number(a.total_price.toFixed(2)),a.packages.forEach((a=>{a.total_price=Number(a.total_price.toFixed(2)),a.items.sort(((a,e)=>Number(a.time_slot||0)-Number(e.time_slot||0)))})),delete a.packageMap})),e},T=async()=>{P.value=!0;try{const a=await N();S.value=(a||[]).map((a=>{const e=Array.isArray(a.cart_items)?a.cart_items:Array.isArray(a.items)?a.items:[];return{...a,cart_items:e,groups:J(e)}}))}finally{P.value=!1}},U=()=>{q.value=!1},B=()=>{D.value?g({data:D.value,success:()=>{y({title:"分享码已复制",icon:"success"}),U()}}):y({title:"分享码为空",icon:"none"})},K=async()=>{if(G.value&&!H.value){H.value=!0;try{const a=await $({plan_id:G.value,force:1});D.value=a.share_code||"",y({title:"已生成新码",icon:"success"})}catch(a){const e="string"==typeof a?a:a.msg||a.message||"生成分享码失败";y({title:e,icon:"none"})}finally{H.value=!1}}},L=async a=>{try{const e=(await $({plan_id:a.id})).share_code||"";((a,e)=>{G.value=a,D.value=e||"",q.value=!0})(a.id,e)}catch(e){const a="string"==typeof e?e:e.msg||e.message||"生成分享码失败";y({title:a,icon:"none"})}},O=()=>{k({url:"/packages/pages/share_plan/share_plan"})};return t((()=>{T()})),(a,e)=>{const l=v(C("page-meta"),w),t=v(C("tn-icon"),z),g=h,N=b,$=j,G=v(C("tn-popup"),x);return s(),c(_,null,[o(l,{"page-style":r(V).pageStyle},null,8,["page-style"]),o(N,{class:"cart-plan-page"},{default:i((()=>[n(" 顶部操作栏 "),o(N,{class:"header-actions"},{default:i((()=>[o(N,{class:"action-card",onClick:O},{default:i((()=>[o(t,{name:"share",size:"40",color:r(V).primaryColor},null,8,["color"]),o(g,{class:"action-text"},{default:i((()=>[u("输入分享码")])),_:1})])),_:1})])),_:1}),n(" 空状态 "),P.value||0!==S.value.length?n("v-if",!0):(s(),d(N,{key:0,class:"empty-state"},{default:i((()=>[o(t,{name:"folder",size:"160",color:"#CCCCCC"}),o(g,{class:"empty-title"},{default:i((()=>[u("暂无保存的方案")])),_:1}),o(g,{class:"empty-desc"},{default:i((()=>[u("保存您的预约方案，随时查看和分享")])),_:1}),o(N,{class:"btn-action",style:f({backgroundColor:r(V).primaryColor}),onClick:O},{default:i((()=>[o(t,{name:"share",size:"32",color:"#FFFFFF"}),o(g,null,{default:i((()=>[u("输入分享码")])),_:1})])),_:1},8,["style"])])),_:1})),n(" 方案列表 "),o(N,{class:"plan-list"},{default:i((()=>[(s(!0),c(_,null,p(S.value,(a=>(s(),d(N,{class:"plan-card",key:a.id},{default:i((()=>{return[n(" 卡片头部 "),o(N,{class:"card-header",style:f({backgroundColor:(e="primary-light-9",{"primary-light-9":"#F3E8FF","cta-light-9":"#FFF7E6"}[e]||"#F5F5F5")})},{default:i((()=>[o(N,{class:"header-left"},{default:i((()=>[o(N,{class:"plan-title"},{default:i((()=>[o(g,{class:"plan-name"},{default:i((()=>[u(m(a.plan_name),1)])),_:2},1024),o(N,{class:"plan-meta"},{default:i((()=>[o(t,{name:"time",size:"24",color:"#999999"}),o(g,{class:"meta-text"},{default:i((()=>{var e;return[u(m((null==(e=a.cart_items)?void 0:e.length)||0)+" 项服务",1)]})),_:2},1024)])),_:2},1024)])),_:2},1024),o(N,{class:"plan-price"},{default:i((()=>[o(g,{class:"price-label"},{default:i((()=>[u("总价")])),_:1}),o(g,{class:"price-symbol",style:f({color:r(V).ctaColor})},{default:i((()=>[u("¥")])),_:1},8,["style"]),o(g,{class:"price-value",style:f({color:r(V).ctaColor})},{default:i((()=>[u(m(I(a.actual_total_price||a.total_price)),1)])),_:2},1032,["style"])])),_:2},1024)])),_:2},1024)])),_:2},1032,["style"]),n(" 方案明细 "),o(N,{class:"plan-detail"},{default:i((()=>{var e;return[o(N,{class:"detail-header"},{default:i((()=>[o(g,{class:"detail-title"},{default:i((()=>[u("包含服务")])),_:1}),o(g,{class:"detail-count"},{default:i((()=>{var e;return[u(m((null==(e=a.cart_items)?void 0:e.length)||0)+"项",1)]})),_:2},1024)])),_:2},1024),(null==(e=a.groups)?void 0:e.length)?(s(),d(N,{key:0,class:"detail-groups"},{default:i((()=>[(s(!0),c(_,null,p(a.groups,(a=>(s(),d(N,{class:"detail-group",key:a.key},{default:i((()=>[o(N,{class:"group-header"},{default:i((()=>[o(N,{class:"staff-section"},{default:i((()=>[o($,{src:a.staff_avatar||"/static/images/default-avatar.png",class:"staff-avatar",mode:"aspectFill"},null,8,["src"]),o(N,{class:"staff-info"},{default:i((()=>[o(g,{class:"staff-name"},{default:i((()=>[u(m(a.staff_name||"未知人员"),1)])),_:2},1024),o(g,{class:"staff-subtitle"},{default:i((()=>[u(m(a.schedule_date),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),o(N,{class:"group-total"},{default:i((()=>[o(g,{class:"group-total-label"},{default:i((()=>[u("小计")])),_:1}),o(g,{class:"group-total-value",style:f({color:r(V).ctaColor})},{default:i((()=>[u(" ¥"+m(I(a.total_price)),1)])),_:2},1032,["style"])])),_:2},1024)])),_:2},1024),o(N,{class:"group-packages"},{default:i((()=>[(s(!0),c(_,null,p(a.packages,(a=>(s(),d(N,{class:"package-group",key:a.key},{default:i((()=>[o(N,{class:"package-header"},{default:i((()=>[o(N,{class:"package-title"},{default:i((()=>[o(t,{name:"gift",size:"24"}),o(g,null,{default:i((()=>[u(m(a.package_name||"未命名套餐"),1)])),_:2},1024)])),_:2},1024),o(g,{class:"package-total"},{default:i((()=>[u("¥"+m(I(a.total_price)),1)])),_:2},1024)])),_:2},1024),o(N,{class:"package-items"},{default:i((()=>[(s(!0),c(_,null,p(a.items,(a=>(s(),d(N,{class:"package-item",key:a._key},{default:i((()=>[o(N,{class:"slot-info"},{default:i((()=>[o(N,{class:"slot-row"},{default:i((()=>[o(g,{class:"slot-label"},{default:i((()=>[u(m(a.time_slot_desc||"未知场次"),1)])),_:2},1024),o(g,{class:"slot-price",style:f({color:r(V).ctaColor})},{default:i((()=>[u(" ¥"+m(I(a.price)),1)])),_:2},1032,["style"])])),_:2},1024),a.remark?(s(),d(N,{key:0,class:"slot-remark"},{default:i((()=>[o(t,{name:"edit",size:"20",color:"#999999"}),o(g,null,{default:i((()=>[u(m(a.remark),1)])),_:2},1024)])),_:2},1024)):n("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):(s(),d(N,{key:1,class:"detail-empty"},{default:i((()=>[o(g,null,{default:i((()=>[u("暂无服务项")])),_:1})])),_:1}))]})),_:2},1024),n(" 操作按钮组 "),o(N,{class:"action-group"},{default:i((()=>[o(N,{class:"action-row"},{default:i((()=>[a.is_default?(s(),d(N,{key:0,class:"action-btn secondary",onClick:a=>{F({title:"取消默认方案",content:"确定要取消默认方案吗？",confirmColor:V.primaryColor,success:async a=>{if(a.confirm)try{await E(),y({title:"已取消默认",icon:"success"}),T()}catch(e){y({title:e.message||"操作失败",icon:"none"})}}})}},{default:i((()=>[o(t,{name:"close",size:"36",color:"#999999"}),o(g,null,{default:i((()=>[u("取消默认")])),_:1})])),_:2},1032,["onClick"])):n("v-if",!0),a.is_default?n("v-if",!0):(s(),d(N,{key:1,class:"action-btn secondary",onClick:e=>(async a=>{try{await M({plan_id:a.id}),y({title:"设置成功",icon:"success"}),T()}catch(e){y({title:e.message||"操作失败",icon:"none"})}})(a)},{default:i((()=>[o(t,{name:"star",size:"36",color:"#999999"}),o(g,null,{default:i((()=>[u("设为默认")])),_:1})])),_:2},1032,["onClick"])),o(N,{class:"action-btn secondary",onClick:e=>L(a)},{default:i((()=>[o(t,{name:"share",size:"36",color:r(V).primaryColor},null,8,["color"]),o(g,null,{default:i((()=>[u("分享方案")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024),o(N,{class:"action-row"},{default:i((()=>[o(N,{class:"action-btn primary",style:f({backgroundColor:r(V).primaryColor}),onClick:e=>(a=>{F({title:"应用方案",content:"应用该方案将覆盖当前购物车，确定继续？",confirmColor:V.primaryColor,success:e=>{e.confirm&&k({url:`/packages/pages/cart/cart?apply_plan=${a.id}`})}})})(a)},{default:i((()=>[o(t,{name:"shopping-cart",size:"36",color:"#FFFFFF"}),o(g,null,{default:i((()=>[u("应用到购物车")])),_:1})])),_:2},1032,["style","onClick"]),o(N,{class:"action-btn danger",onClick:e=>(a=>{a.is_default?y({title:"默认方案不能删除",icon:"none"}):F({title:"删除方案",content:"确定要删除该方案吗？",confirmColor:"#FF2C3C",success:async e=>{e.confirm&&(await A({plan_id:a.id}),y({title:"删除成功",icon:"success"}),T())}})})(a)},{default:i((()=>[o(t,{name:"delete",size:"36",color:"#FF2C3C"})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)];var e})),_:2},1024)))),128))])),_:1}),o(G,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=a=>q.value=a),mode:"center","border-radius":24,"mask-close-able":!0},{default:i((()=>[o(N,{class:"share-modal"},{default:i((()=>[o(g,{class:"modal-title"},{default:i((()=>[u("分享方案")])),_:1}),o(g,{class:"modal-desc"},{default:i((()=>[u("分享码")])),_:1}),o(N,{class:"share-code"},{default:i((()=>[u(m(D.value),1)])),_:1}),o(N,{class:"modal-actions"},{default:i((()=>[o(N,{class:"modal-btn btn-primary",style:f({backgroundColor:r(V).primaryColor}),onClick:B},{default:i((()=>[u(" 复制分享码 ")])),_:1},8,["style"]),o(N,{class:"modal-btn btn-secondary",onClick:K},{default:i((()=>[u(" 生成新码 ")])),_:1}),o(N,{class:"modal-btn btn-ghost",onClick:U},{default:i((()=>[u(" 关闭 ")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})],64)}}}),[["__scopeId","data-v-4b7bf2df"]]);export{P as default};
