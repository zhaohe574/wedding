import{d as e,u as a,s as l,c as t,O as s,P as c,o,h as n,e as i,f as r,w as u,g as d,b as f,j as _,n as p,F as m,t as g,i as v,y as k,aD as y,aP as C,k as b,r as h,a as F,l as j,m as w,A as z,G as x}from"./index-e3492752.js";import{_ as $}from"./page-meta.a4be6114.js";import{_ as N}from"./icon.e613abcd.js";import{_ as M}from"./input.1776ceae.js";import{_ as V}from"./popup.b8b85cf1.js";import{g as E,b as A,s as D,c as G,d as I,t as P,e as S,f as U}from"./cart.c9c79b39.js";import{_ as H}from"./_plugin-vue_export-helper.1b428a4d.js";import"./index.f1be293a.js";import"./is-number.7ef6fec2.js";import"./_objectToString.c905654b.js";import"./event.5568c9d8.js";import"./index.23c2867d.js";import"./install.8446dea8.js";import"./is-empty.c0d66e4a.js";import"./is-boolean.00bf65dc.js";import"./index.89b6df5d.js";import"./index.04c93aab.js";import"./debounce.096fb07a.js";import"./clone-deep.2124c060.js";import"./z-index.5f93cfb9.js";const J=H(e({__name:"cart",setup(e){const H=a(),J=l(!1),O=l({items:[],total_price:0,total_count:0,conflicts:[],package_conflicts:[],selected_count:0}),T=l(!1),q=l(""),B=l(!1),K=l(null),L=l(!1),Q=t((()=>O.value.package_conflicts||[])),R=t((()=>O.value.items.length>0&&O.value.selected_count===O.value.items.length)),W=t((()=>{const e=[],a=new Map;return(O.value.items||[]).forEach((l=>{const t=`${l.staff_id}-${l.schedule_date}`;let s=a.get(t);s||(s={key:t,staff:l.staff,schedule_date:l.schedule_date,packages:[],total_price:0,packageMap:new Map},a.set(t,s),e.push(s)),s.total_price+=Number(l.price||0);const c=Number(l.package_id||0);let o=s.packageMap.get(c);o||(o={key:`${t}-${c}`,package:l.package,items:[],total_price:0},s.packageMap.set(c,o),s.packages.push(o)),o.items.push(l),o.total_price+=Number(l.price||0)})),e.forEach((e=>{e.packages.forEach((e=>{e.items.sort(((e,a)=>Number(e.time_slot||0)-Number(a.time_slot||0)))})),delete e.packageMap})),e})),X=e=>{if(null==e?void 0:e.time_slot_desc)return e.time_slot_desc;const a=Number(null==e?void 0:e.time_slot);return Number.isFinite(a)&&{0:"全天",1:"早礼",2:"午宴",3:"晚宴"}[a]||"未知场次"},Y=async()=>{J.value=!0;try{const e=await E();O.value=e}finally{J.value=!1}},Z=async()=>{await D({selected:!R.value}),Y()},ee=()=>{C({title:"清空购物车",content:"确定要清空购物车吗？",confirmColor:"#FF2C3C",success:async e=>{e.confirm&&(await G(),y({title:"已清空",icon:"success"}),Y())}})},ae=()=>{0!==O.value.selected_count?(q.value="",T.value=!0):y({title:"请先选择项目",icon:"none"})},le=()=>{T.value=!1},te=async()=>{if(!q.value.trim())return void y({title:"请输入方案名称",icon:"none"});const e=O.value.items.filter((e=>e.is_selected)).map((e=>e.id));try{await I({plan_name:q.value,cart_ids:e}),q.value="",T.value=!1,y({title:"保存成功",icon:"success"})}catch(a){console.error("保存方案失败:",a);const e="string"==typeof a?a:a.msg||a.message||"保存失败";y({title:e,icon:"none"})}},se=()=>{0!==O.value.selected_count?O.value.conflicts.length>0?y({title:"请先处理档期冲突",icon:"none"}):Q.value.length>0?y({title:"存在套餐预订冲突，请处理",icon:"none"}):b({url:"/packages/pages/order_confirm/order_confirm"}):y({title:"请先选择项目",icon:"none"})},ce=()=>{b({url:"/packages/pages/staff_list/staff_list"})},oe=()=>{b({url:"/packages/pages/cart_plan/cart_plan"})};return s((e=>{const a=Number(null==e?void 0:e.apply_plan);Number.isFinite(a)&&a>0&&(K.value=a)})),c((()=>{K.value?(async e=>{if(e&&!L.value){L.value=!0;try{const a=await A({plan_id:e}),l=Number((null==a?void 0:a.copied_count)||0);y({title:l>0?`已应用${l}个场次`:"应用成功",icon:"success"})}catch(a){const e="string"==typeof a?a:a.msg||a.message||"应用失败";y({title:e,icon:"none"})}finally{L.value=!1,K.value=null,Y()}}})(K.value):Y()})),(e,a)=>{const l=h(F("page-meta"),$),t=h(F("tn-icon"),N),s=j,c=w,b=x,E=h(F("tn-input"),M),A=h(F("tn-popup"),V);return o(),n(m,null,[i(l,{"page-style":r(H).pageStyle},null,8,["page-style"]),i(c,{class:"cart-page"},{default:u((()=>[d(" 空状态 "),J.value||0!==O.value.items.length?(o(),n(m,{key:1},[d(" 购物车内容 "),i(c,{class:"cart-content"},{default:u((()=>[d(" 档期冲突提示 "),O.value.conflicts.length>0?(o(),f(c,{key:0,class:"alert-card alert-warning"},{default:u((()=>[i(t,{name:"warning",size:"40",color:"#FA8C16"}),i(c,{class:"alert-content"},{default:u((()=>[i(s,{class:"alert-title"},{default:u((()=>[_("档期冲突提醒")])),_:1}),i(s,{class:"alert-desc"},{default:u((()=>[_(g(O.value.conflicts.length)+"个项目存在时间冲突，请调整",1)])),_:1})])),_:1})])),_:1})):d("v-if",!0),d(" 套餐冲突提示 "),r(Q).length>0?(o(),f(c,{key:1,class:"alert-card alert-info"},{default:u((()=>[i(t,{name:"info-circle",size:"40",color:"#1890FF"}),i(c,{class:"alert-content"},{default:u((()=>[i(s,{class:"alert-title"},{default:u((()=>[_("预订冲突提醒")])),_:1}),i(s,{class:"alert-desc"},{default:u((()=>[_(g(r(Q).length)+"个套餐当日已被预订",1)])),_:1}),i(c,{class:"alert-link",onClick:a[0]||(a[0]=e=>B.value=!B.value)},{default:u((()=>[i(s,null,{default:u((()=>[_(g(B.value?"收起详情":"查看详情"),1)])),_:1}),i(t,{name:B.value?"arrow-up":"arrow-down",size:"24"},null,8,["name"])])),_:1})])),_:1})])),_:1})):d("v-if",!0),d(" 冲突详情列表 "),B.value&&r(Q).length>0?(o(),f(c,{key:2,class:"conflict-details"},{default:u((()=>[(o(!0),n(m,null,v(r(Q),(e=>(o(),f(c,{class:"conflict-item",key:e.package_id},{default:u((()=>[i(c,{class:"conflict-info"},{default:u((()=>[i(t,{name:"alert-circle",size:"32",color:"#FF2C3C"}),i(s,{class:"conflict-name"},{default:u((()=>[_(g(e.package_name),1)])),_:2},1024)])),_:2},1024),i(s,{class:"conflict-date"},{default:u((()=>[_(g(e.date),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):d("v-if",!0),d(" 全选栏 "),i(c,{class:"select-bar"},{default:u((()=>[i(c,{class:"select-all",onClick:Z},{default:u((()=>[i(c,{class:k(["checkbox",{checked:r(R)}]),style:p(r(R)?{background:`linear-gradient(135deg, ${r(H).primaryColor} 0%, ${r(H).primaryColor} 100%)`,borderColor:r(H).primaryColor}:{})},{default:u((()=>[r(R)?(o(),f(t,{key:0,name:"check",size:"28",color:"#FFFFFF"})):d("v-if",!0)])),_:1},8,["class","style"]),i(s,{class:"select-text"},{default:u((()=>[_("全选")])),_:1})])),_:1}),i(s,{class:"item-count"},{default:u((()=>[_("共 "+g(O.value.items.length)+" 项",1)])),_:1})])),_:1}),d(" 购物车列表 "),i(c,{class:"cart-list"},{default:u((()=>[(o(!0),n(m,null,v(r(W),(e=>(o(),f(c,{class:"cart-group",key:e.key},{default:u((()=>[i(c,{class:"group-header"},{default:u((()=>[i(c,{class:"staff-section"},{default:u((()=>{var a;return[i(b,{src:(null==(a=e.staff)?void 0:a.avatar)||"/static/images/default-avatar.png",class:"staff-avatar",mode:"aspectFill"},null,8,["src"]),i(c,{class:"staff-info"},{default:u((()=>[i(s,{class:"staff-name"},{default:u((()=>{var a;return[_(g((null==(a=e.staff)?void 0:a.name)||"未知人员"),1)]})),_:2},1024),i(s,{class:"staff-subtitle"},{default:u((()=>[_(g(e.schedule_date),1)])),_:2},1024)])),_:2},1024)]})),_:2},1024),i(c,{class:"group-total"},{default:u((()=>[i(s,{class:"group-total-label"},{default:u((()=>[_("小计")])),_:1}),i(s,{class:"group-total-value",style:p({color:r(H).ctaColor})},{default:u((()=>[_("¥"+g(e.total_price),1)])),_:2},1032,["style"])])),_:2},1024)])),_:2},1024),i(c,{class:"group-packages"},{default:u((()=>[(o(!0),n(m,null,v(e.packages,(e=>(o(),f(c,{class:"package-group",key:e.key},{default:u((()=>[i(c,{class:"package-header"},{default:u((()=>[i(c,{class:"package-title"},{default:u((()=>[i(t,{name:"gift",size:"24"}),i(s,null,{default:u((()=>{var a;return[_(g((null==(a=e.package)?void 0:a.name)||"未命名套餐"),1)]})),_:2},1024)])),_:2},1024),i(c,{class:"package-actions"},{default:u((()=>[i(s,{class:"package-total"},{default:u((()=>[_("¥"+g(e.total_price),1)])),_:2},1024),i(c,{class:"package-delete",onClick:z((a=>(e=>{const a=((null==e?void 0:e.items)||[]).map((e=>e.id)).filter((e=>e));0!==a.length&&C({title:"删除确认",content:"确定要删除该套餐下所有场次吗？",confirmColor:"#FF2C3C",success:async e=>{e.confirm&&(await U({ids:a}),y({title:"删除成功",icon:"success"}),Y())}})})(e)),["stop"])},{default:u((()=>[i(t,{name:"delete",size:"24",color:"#999999"}),i(s,null,{default:u((()=>[_("删除")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024),i(c,{class:"package-items"},{default:u((()=>[(o(!0),n(m,null,v(e.items,(e=>(o(),f(c,{class:k(["package-item",{unavailable:!e.is_available}]),key:e.id},{default:u((()=>[i(c,{class:"slot-main",onClick:a=>(async e=>{await P({id:e.id}),Y()})(e)},{default:u((()=>[i(c,{class:k(["checkbox",{checked:e.is_selected}]),style:p(e.is_selected?{background:`linear-gradient(135deg, ${r(H).primaryColor} 0%, ${r(H).primaryColor} 100%)`,borderColor:r(H).primaryColor}:{})},{default:u((()=>[e.is_selected?(o(),f(t,{key:0,name:"check",size:"28",color:"#FFFFFF"})):d("v-if",!0)])),_:2},1032,["class","style"]),i(c,{class:"slot-info"},{default:u((()=>[i(c,{class:"slot-row"},{default:u((()=>[i(s,{class:"slot-label"},{default:u((()=>[_(g(X(e)),1)])),_:2},1024),i(s,{class:"slot-price",style:p({color:r(H).ctaColor})},{default:u((()=>[_("¥"+g(e.price),1)])),_:2},1032,["style"])])),_:2},1024),e.is_available?d("v-if",!0):(o(),f(c,{key:0,class:"slot-status"},{default:u((()=>[i(t,{name:"close-circle",size:"24",color:"#FF2C3C"}),i(s,null,{default:u((()=>[_(g(e.unavailable_reason||"档期不可用"),1)])),_:2},1024)])),_:2},1024))])),_:2},1024)])),_:2},1032,["onClick"]),i(c,{class:"slot-actions",onClick:z((a=>(e=>{C({title:"删除确认",content:"确定要删除该项吗？",confirmColor:"#FF2C3C",success:async a=>{a.confirm&&(await S({id:e.id}),y({title:"删除成功",icon:"success"}),Y())}})})(e)),["stop"])},{default:u((()=>[i(t,{name:"delete",size:"28",color:"#999999"}),i(s,{class:"delete-text"},{default:u((()=>[_("删除")])),_:1})])),_:2},1032,["onClick"])])),_:2},1032,["class"])))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:1}),i(c,{class:"action-bar"},{default:u((()=>[i(c,{class:"action-btn",onClick:ae},{default:u((()=>[i(t,{name:"folder-add",size:"48",color:r(H).primaryColor},null,8,["color"]),i(s,{class:"action-text"},{default:u((()=>[_("保存方案")])),_:1})])),_:1}),i(c,{class:"action-btn",onClick:oe},{default:u((()=>[i(t,{name:"folder",size:"48",color:r(H).primaryColor},null,8,["color"]),i(s,{class:"action-text"},{default:u((()=>[_("我的方案")])),_:1})])),_:1}),i(c,{class:"action-btn",onClick:ee},{default:u((()=>[i(t,{name:"delete",size:"48",color:"#FF2C3C"}),i(s,{class:"action-text"},{default:u((()=>[_("清空")])),_:1})])),_:1})])),_:1})])),_:1})],2112)):(o(),f(c,{key:0,class:"empty-state"},{default:u((()=>[i(t,{name:"shopping-cart",size:"160",color:"#CCCCCC"}),i(s,{class:"empty-title"},{default:u((()=>[_("购物车是空的")])),_:1}),i(s,{class:"empty-desc"},{default:u((()=>[_("快去挑选心仪的服务吧")])),_:1}),i(c,{class:"btn-browse",style:p({background:`linear-gradient(135deg, ${r(H).primaryColor} 0%, ${r(H).primaryColor} 100%)`,color:r(H).btnColor}),onClick:ce},{default:u((()=>[i(t,{name:"search",size:"32",color:r(H).btnColor},null,8,["color"]),i(s,null,{default:u((()=>[_("开始选购")])),_:1})])),_:1},8,["style"])])),_:1})),d(" 底部结算栏 "),O.value.items.length>0?(o(),f(c,{key:2,class:"checkout-bar"},{default:u((()=>[i(c,{class:"checkout-info"},{default:u((()=>[i(c,{class:"selected-count"},{default:u((()=>[i(t,{name:"check-circle",size:"28",color:r(H).primaryColor},null,8,["color"]),i(s,null,{default:u((()=>[_("已选 "+g(O.value.selected_count)+" 项",1)])),_:1})])),_:1}),i(c,{class:"total-section"},{default:u((()=>[i(s,{class:"total-label"},{default:u((()=>[_("合计")])),_:1}),i(s,{class:"total-symbol",style:p({color:r(H).ctaColor})},{default:u((()=>[_("¥")])),_:1},8,["style"]),i(s,{class:"total-value",style:p({color:r(H).ctaColor})},{default:u((()=>[_(g(O.value.total_price),1)])),_:1},8,["style"])])),_:1})])),_:1}),i(c,{class:k(["checkout-btn",{disabled:0===O.value.selected_count||O.value.conflicts.length>0||r(Q).length>0}]),style:p(0===O.value.selected_count||O.value.conflicts.length>0||r(Q).length>0?{}:{background:`linear-gradient(135deg, ${r(H).primaryColor} 0%, ${r(H).primaryColor} 100%)`}),onClick:se},{default:u((()=>[i(s,null,{default:u((()=>[_("下单")])),_:1})])),_:1},8,["class","style"])])),_:1})):d("v-if",!0),d(" 保存方案弹窗 "),i(A,{modelValue:T.value,"onUpdate:modelValue":a[2]||(a[2]=e=>T.value=e),mode:"center","border-radius":24,"mask-close-able":!1},{default:u((()=>[i(c,{class:"plan-modal"},{default:u((()=>[i(s,{class:"modal-title"},{default:u((()=>[_("保存为方案")])),_:1}),i(s,{class:"modal-desc"},{default:u((()=>[_("为您的预约方案起个名字")])),_:1}),i(E,{modelValue:q.value,"onUpdate:modelValue":a[1]||(a[1]=e=>q.value=e),placeholder:"例如：婚礼策划方案",maxlength:50,focus:T.value,border:!0,clearable:!0,height:"80"},null,8,["modelValue","focus"]),i(c,{class:"modal-actions"},{default:u((()=>[i(c,{class:"modal-btn btn-cancel",onClick:le},{default:u((()=>[_("取消")])),_:1}),i(c,{class:"modal-btn btn-confirm",style:p({background:`linear-gradient(135deg, ${r(H).primaryColor} 0%, ${r(H).primaryColor} 100%)`}),onClick:te},{default:u((()=>[_("确定")])),_:1},8,["style"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})],64)}}}),[["__scopeId","data-v-6557c8d1"]]);export{J as default};
