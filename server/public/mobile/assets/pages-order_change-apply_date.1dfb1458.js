import{d as e,s as a,M as l,c as t,O as s,o as u,h as c,e as n,w as o,g as r,b as i,j as d,t as _,F as f,i as m,f as p,aP as g,aq as v,aD as h,aV as y,b5 as k,r as b,a as w,m as x,G as C,l as j,a_ as $,b0 as D,aJ as F,b6 as z,b7 as S,y as V}from"./index-e3492752.js";import{_ as P}from"./navigation-bar.2687311c.js";import{_ as A}from"./page-meta.a4be6114.js";import{h as T,i as Y}from"./orderChange.66dcaaa9.js";import{e as M}from"./order.1e435880.js";import{_ as O}from"./_plugin-vue_export-helper.1b428a4d.js";const U=O(e({__name:"apply_date",setup(e){const O=a(0),U=a(null),q=a(!1),B=a(!1),G=a(!1),I=l({new_date:"",new_time_slot:null,reason:"",attach_images:[]}),J=[{value:0,label:"全天"},{value:1,label:"早礼"},{value:2,label:"午宴"},{value:3,label:"晚宴"}],N=a(),E=a(),H=a([0,0,0]),K=a(0),L=(new Date).getFullYear(),Q=Array.from({length:3},((e,a)=>L+a)),R=Array.from({length:12},((e,a)=>a+1)),W=t((()=>{const e=Q[H.value[0]],a=R[H.value[1]],l=new Date(e,a,0).getDate();return Array.from({length:l},((e,a)=>a+1))})),X=e=>{H.value=e.detail.value},Z=()=>{var e;null==(e=N.value)||e.close()},ee=()=>{const e=Q[H.value[0]],a=String(R[H.value[1]]).padStart(2,"0"),l=String(W.value[H.value[2]]).padStart(2,"0");I.new_date=`${e}-${a}-${l}`,Z()},ae=()=>{var e;null==(e=E.value)||e.close()},le=()=>{I.new_time_slot=K.value,ae()},te=()=>{y({count:5-I.attach_images.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{I.attach_images.push(...e.tempFilePaths)}})},se=async()=>{if(I.new_date)if(null!==I.new_time_slot){q.value=!0;try{const e=await Y({order_id:O.value,new_date:I.new_date,new_time_slot:I.new_time_slot,reason:I.reason,attach_images:I.attach_images});h({title:"申请已提交"}),setTimeout((()=>{k({url:`/pages/order_change/change_detail?id=${e.change_id}`})}),1500)}catch(e){h({title:e.message||"提交失败",icon:"none"})}finally{q.value=!1}}else h({title:"请选择时间段",icon:"none"});else h({title:"请选择新服务日期",icon:"none"})};return s((e=>{e.order_id&&(O.value=Number(e.order_id),(async()=>{try{const e=await M({id:O.value});U.value=e}catch(e){console.error(e)}})(),(async()=>{try{const e=await T({order_id:O.value});e.can_change||g({title:"提示",content:e.message,showCancel:!1,success:()=>{v()}})}catch(e){h({title:e.message||"检查失败",icon:"none"})}})())})),watch((()=>B.value),(e=>{e&&(()=>{var e;const a=new Date,l=Q.indexOf(a.getFullYear()),t=a.getMonth(),s=a.getDate()-1;H.value=[l>=0?l:0,t,s],null==(e=N.value)||e.open()})()})),watch((()=>G.value),(e=>{var a;e&&(K.value=I.new_time_slot??0,null==(a=E.value)||a.open())})),(e,a)=>{const l=b(w("navigation-bar"),P),t=b(w("page-meta"),A),s=x,g=C,v=j,h=$("uni-icons"),y=D,k=F,T=z,Y=S,M=$("uni-popup");return u(),c(f,null,[n(t,{"page-style":e.$theme.pageStyle},{default:o((()=>[n(l,{title:"申请改期","front-color":e.$theme.navColor,"background-color":e.$theme.navBgColor},null,8,["front-color","background-color"])])),_:1},8,["page-style"]),n(s,{class:"apply-page"},{default:o((()=>[r(" 订单信息 "),U.value?(u(),i(s,{key:0,class:"bg-white p-4"},{default:o((()=>[n(s,{class:"section-title"},{default:o((()=>[d("订单信息")])),_:1}),n(s,{class:"order-card"},{default:o((()=>[n(s,{class:"text-sm text-gray-500"},{default:o((()=>[d("订单号: "+_(U.value.order_sn),1)])),_:1}),U.value.items&&U.value.items.length>0?(u(),i(s,{key:0,class:"flex items-center mt-2"},{default:o((()=>{var e;return[n(g,{src:(null==(e=U.value.items[0].staff)?void 0:e.avatar)||"/static/images/default-avatar.png",class:"w-12 h-12 rounded-lg mr-3",mode:"aspectFill"},null,8,["src"]),n(s,{class:"flex-1"},{default:o((()=>[n(s,{class:"text-sm font-medium"},{default:o((()=>[d(_(U.value.items[0].staff_name),1)])),_:1}),n(s,{class:"text-xs text-gray-400"},{default:o((()=>[d(_(U.value.items[0].package_name),1)])),_:1})])),_:1})]})),_:1})):r("v-if",!0),n(s,{class:"mt-2 p-3 bg-orange-50 rounded-lg"},{default:o((()=>[n(s,{class:"text-sm"},{default:o((()=>[n(v,{class:"text-gray-500"},{default:o((()=>[d("当前服务日期: ")])),_:1}),n(v,{class:"text-orange-500 font-bold"},{default:o((()=>[d(_(U.value.service_date),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):r("v-if",!0),r(" 选择新日期 "),n(s,{class:"bg-white mt-3 p-4"},{default:o((()=>[n(s,{class:"section-title"},{default:o((()=>[d("选择新服务日期")])),_:1}),n(s,{class:"form-item",onClick:a[0]||(a[0]=e=>B.value=!0)},{default:o((()=>[n(v,{class:"label"},{default:o((()=>[d("新服务日期")])),_:1}),n(s,{class:"value-area"},{default:o((()=>[I.new_date?(u(),i(v,{key:0,class:"text-primary"},{default:o((()=>[d(_(I.new_date),1)])),_:1})):(u(),i(v,{key:1,class:"placeholder"},{default:o((()=>[d("请选择日期")])),_:1})),n(h,{type:"right",size:"16",color:"#999"})])),_:1})])),_:1}),n(s,{class:"form-item",onClick:a[1]||(a[1]=e=>G.value=!0)},{default:o((()=>[n(v,{class:"label"},{default:o((()=>[d("时间段")])),_:1}),n(s,{class:"value-area"},{default:o((()=>[null!==I.new_time_slot?(u(),i(v,{key:0,class:"text-primary"},{default:o((()=>{var e;return[d(_(null==(e=J[I.new_time_slot])?void 0:e.label),1)]})),_:1})):(u(),i(v,{key:1,class:"placeholder"},{default:o((()=>[d("请选择时间段")])),_:1})),n(h,{type:"right",size:"16",color:"#999"})])),_:1})])),_:1})])),_:1}),r(" 申请原因 "),n(s,{class:"bg-white mt-3 p-4"},{default:o((()=>[n(s,{class:"section-title"},{default:o((()=>[d("申请原因")])),_:1}),n(y,{modelValue:I.reason,"onUpdate:modelValue":a[2]||(a[2]=e=>I.reason=e),class:"reason-input",placeholder:"请填写改期原因（选填）",maxlength:"200"},null,8,["modelValue"]),n(s,{class:"text-right text-xs text-gray-400"},{default:o((()=>[d(_(I.reason.length)+"/200",1)])),_:1})])),_:1}),r(" 附件图片 "),n(s,{class:"bg-white mt-3 p-4"},{default:o((()=>[n(s,{class:"section-title"},{default:o((()=>[d("附件图片（选填）")])),_:1}),n(s,{class:"image-uploader"},{default:o((()=>[(u(!0),c(f,null,m(I.attach_images,((e,a)=>(u(),i(s,{key:a,class:"image-item"},{default:o((()=>[n(g,{src:e,class:"upload-image",mode:"aspectFill"},null,8,["src"]),n(s,{class:"delete-btn",onClick:e=>(e=>{I.attach_images.splice(e,1)})(a)},{default:o((()=>[n(h,{type:"close",size:"14",color:"#fff"})])),_:2},1032,["onClick"])])),_:2},1024)))),128)),I.attach_images.length<5?(u(),i(s,{key:0,class:"add-image",onClick:te},{default:o((()=>[n(h,{type:"plusempty",size:"40",color:"#ccc"}),n(v,{class:"text-xs text-gray-400 mt-1"},{default:o((()=>[d("上传图片")])),_:1})])),_:1})):r("v-if",!0)])),_:1}),n(s,{class:"text-xs text-gray-400 mt-2"},{default:o((()=>[d("最多上传5张图片，支持jpg、png格式")])),_:1})])),_:1}),r(" 提交按钮 "),n(s,{class:"bottom-actions"},{default:o((()=>[n(k,{class:"btn-submit",disabled:q.value,onClick:se},{default:o((()=>[d(_(q.value?"提交中...":"提交申请"),1)])),_:1},8,["disabled"])])),_:1}),r(" 日期选择器 "),n(M,{ref_key:"datePopup",ref:N,type:"bottom","safe-area":!1},{default:o((()=>[n(s,{class:"picker-popup"},{default:o((()=>[n(s,{class:"picker-header"},{default:o((()=>[n(v,{class:"cancel",onClick:Z},{default:o((()=>[d("取消")])),_:1}),n(v,{class:"title"},{default:o((()=>[d("选择日期")])),_:1}),n(v,{class:"confirm",onClick:ee},{default:o((()=>[d("确定")])),_:1})])),_:1}),n(Y,{value:H.value,onChange:X,class:"picker-view"},{default:o((()=>[n(T,null,{default:o((()=>[(u(!0),c(f,null,m(p(Q),(e=>(u(),i(s,{key:e,class:"picker-item"},{default:o((()=>[d(_(e)+"年",1)])),_:2},1024)))),128))])),_:1}),n(T,null,{default:o((()=>[(u(!0),c(f,null,m(p(R),(e=>(u(),i(s,{key:e,class:"picker-item"},{default:o((()=>[d(_(e)+"月",1)])),_:2},1024)))),128))])),_:1}),n(T,null,{default:o((()=>[(u(!0),c(f,null,m(p(W),(e=>(u(),i(s,{key:e,class:"picker-item"},{default:o((()=>[d(_(e)+"日",1)])),_:2},1024)))),128))])),_:1})])),_:1},8,["value"])])),_:1})])),_:1},512),r(" 时间段选择器 "),n(M,{ref_key:"timePopup",ref:E,type:"bottom","safe-area":!1},{default:o((()=>[n(s,{class:"picker-popup"},{default:o((()=>[n(s,{class:"picker-header"},{default:o((()=>[n(v,{class:"cancel",onClick:ae},{default:o((()=>[d("取消")])),_:1}),n(v,{class:"title"},{default:o((()=>[d("选择时间段")])),_:1}),n(v,{class:"confirm",onClick:le},{default:o((()=>[d("确定")])),_:1})])),_:1}),n(s,{class:"time-options"},{default:o((()=>[(u(),c(f,null,m(J,(e=>n(s,{key:e.value,class:V(["time-option",{active:K.value===e.value}]),onClick:a=>K.value=e.value},{default:o((()=>[d(_(e.label),1)])),_:2},1032,["class","onClick"]))),64))])),_:1})])),_:1})])),_:1},512)])),_:1})],64)}}}),[["__scopeId","data-v-2409438d"]]);export{U as default};
