import{d as a,u as e,a1 as t,s as l,M as s,c as o,O as c,P as r,o as u,h as i,e as n,f as d,w as m,b as _,j as p,F as f,i as g,g as v,t as b,n as y,y as k,aD as h,b5 as j,r as w,a as x,l as V,m as N,G as C}from"./index-e3492752.js";import{_ as $}from"./page-meta.a4be6114.js";import{_ as M}from"./loading.2b80eb94.js";import{_ as U}from"./input.1776ceae.js";import{_ as F}from"./icon.e613abcd.js";import{p as E,h as I}from"./order.1e435880.js";import{_ as z}from"./_plugin-vue_export-helper.1b428a4d.js";import"./index.f1be293a.js";import"./index.89b6df5d.js";import"./is-number.7ef6fec2.js";import"./_objectToString.c905654b.js";import"./event.5568c9d8.js";import"./index.23c2867d.js";import"./install.8446dea8.js";import"./is-empty.c0d66e4a.js";import"./is-boolean.00bf65dc.js";import"./index.04c93aab.js";import"./debounce.096fb07a.js";import"./clone-deep.2124c060.js";const A=z(a({__name:"order_confirm",setup(a){const z=e(),A=t(),D=l(!1),G=l(!1),S=l(!1),H=l({items:[],total_amount:0,coupon_amount:0,pay_amount:0,deposit_amount:0,balance_amount:0}),O=s({contact_name:"",contact_mobile:"",service_address:"",remark:""}),P=o((()=>Array.isArray(H.value.items)&&H.value.items.length>0)),R=o((()=>P.value&&!D.value&&!G.value)),T=a=>Number(a||0).toFixed(2),q=o((()=>{const a=[],e=new Map;return(H.value.items||[]).forEach((t=>{const l=Number(t.staff_id||0),s=t.schedule_date||"",o=`${l}-${s}`;let c=e.get(o);c||(c={key:o,staff:t.staff,schedule_date:s,packages:[],total_price:0,packageMap:new Map},e.set(o,c),a.push(c)),c.total_price+=Number(t.price||0);const r=Number(t.package_id||0);let u=c.packageMap.get(r);u||(u={key:`${o}-${r}`,package:t.package,items:[],total_price:0},c.packageMap.set(r,u),c.packages.push(u)),u.items.push(t),u.total_price+=Number(t.price||0)})),a.forEach((a=>{a.packages.forEach((a=>{a.items.sort(((a,e)=>Number(a.time_slot||0)-Number(e.time_slot||0)))})),delete a.packageMap})),a})),B=a=>{if(null==a?void 0:a.time_slot_desc)return a.time_slot_desc;const e=Number(null==a?void 0:a.time_slot);return Number.isFinite(e)&&{0:"全天",1:"早礼",2:"午宴",3:"晚宴"}[e]||"未知场次"},J=a=>{h({title:a,icon:"none"}),j({url:"/packages/pages/cart/cart"})},K=async()=>{D.value=!0;try{const a=await E({});H.value={items:(null==a?void 0:a.items)||[],total_amount:(null==a?void 0:a.total_amount)||0,coupon_amount:(null==a?void 0:a.coupon_amount)||0,pay_amount:(null==a?void 0:a.pay_amount)||0,deposit_amount:(null==a?void 0:a.deposit_amount)||0,balance_amount:(null==a?void 0:a.balance_amount)||0},H.value.items.length||J("暂无可结算的服务")}catch(a){const e="string"==typeof a?a:a.msg||a.message||"加载失败";J(e)}finally{D.value=!1}},L=async()=>{if(R.value)if(O.contact_name.trim())if(O.contact_mobile.trim())if(a=O.contact_mobile.trim(),/^1[3-9]\d{9}$/.test(a)){var a;G.value=!0;try{const a={contact_name:O.contact_name.trim(),contact_mobile:O.contact_mobile.trim()};O.service_address.trim()&&(a.service_address=O.service_address.trim()),O.remark.trim()&&(a.remark=O.remark.trim());const e=await I(a),t=Number((null==e?void 0:e.order_id)||(null==e?void 0:e.id)||0);h({title:"订单已提交",icon:"success"}),j(t?{url:`/pages/order_detail/order_detail?id=${t}`}:{url:"/pages/order/order"})}catch(e){const a="string"==typeof e?e:e.msg||e.message||"提交失败";h({title:a,icon:"none"})}finally{G.value=!1}}else h({title:"手机号格式不正确",icon:"none"});else h({title:"请输入手机号码",icon:"none"});else h({title:"请输入联系人姓名",icon:"none"})},Q=async()=>{await(async()=>{await A.getUser();const a=A.userInfo||{};O.contact_name||(O.contact_name=a.real_name||a.nickname||""),O.contact_mobile||(O.contact_mobile=a.mobile||"")})(),await K(),S.value=!0};return c((()=>{Q()})),r((()=>{S.value&&K()})),(a,e)=>{const t=w(x("page-meta"),$),l=w(x("tn-loading"),M),s=V,o=N,c=w(x("tn-input"),U),r=C,h=w(x("tn-icon"),F);return u(),i(f,null,[n(t,{"page-style":d(z).pageStyle},null,8,["page-style"]),n(o,{class:"order-confirm-page"},{default:m((()=>[D.value?(u(),_(o,{key:0,class:"loading-state"},{default:m((()=>[n(l,{size:"60",mode:"flower"}),n(s,{class:"loading-text"},{default:m((()=>[p("加载中...")])),_:1})])),_:1})):(u(),_(o,{key:1},{default:m((()=>[n(o,{class:"section"},{default:m((()=>[n(o,{class:"section-title"},{default:m((()=>[p("联系人信息")])),_:1}),n(o,{class:"form-item"},{default:m((()=>[n(s,{class:"form-label"},{default:m((()=>[p("联系人")])),_:1}),n(c,{modelValue:O.contact_name,"onUpdate:modelValue":e[0]||(e[0]=a=>O.contact_name=a),placeholder:"请输入联系人姓名",border:!0,height:"80"},null,8,["modelValue"])])),_:1}),n(o,{class:"form-item"},{default:m((()=>[n(s,{class:"form-label"},{default:m((()=>[p("手机号码")])),_:1}),n(c,{modelValue:O.contact_mobile,"onUpdate:modelValue":e[1]||(e[1]=a=>O.contact_mobile=a),placeholder:"请输入手机号码",type:"number",border:!0,height:"80"},null,8,["modelValue"])])),_:1}),n(o,{class:"form-item"},{default:m((()=>[n(s,{class:"form-label"},{default:m((()=>[p("服务地址")])),_:1}),n(c,{modelValue:O.service_address,"onUpdate:modelValue":e[2]||(e[2]=a=>O.service_address=a),placeholder:"请输入服务地址（选填）",border:!0,height:"80"},null,8,["modelValue"])])),_:1}),n(o,{class:"form-item"},{default:m((()=>[n(s,{class:"form-label"},{default:m((()=>[p("备注")])),_:1}),n(c,{modelValue:O.remark,"onUpdate:modelValue":e[3]||(e[3]=a=>O.remark=a),type:"textarea",placeholder:"请输入备注（选填）",border:!0,height:"120"},null,8,["modelValue"])])),_:1})])),_:1}),d(P)?(u(),_(o,{key:0,class:"section"},{default:m((()=>[n(o,{class:"section-title"},{default:m((()=>[p("服务项目")])),_:1}),(u(!0),i(f,null,g(d(q),(a=>(u(),_(o,{class:"service-group",key:a.key},{default:m((()=>[n(o,{class:"group-header"},{default:m((()=>[n(o,{class:"staff-section"},{default:m((()=>{var e;return[n(r,{src:(null==(e=a.staff)?void 0:e.avatar)||"/static/images/default-avatar.png",class:"staff-avatar",mode:"aspectFill"},null,8,["src"]),n(o,{class:"staff-info"},{default:m((()=>[n(s,{class:"staff-name"},{default:m((()=>{var e;return[p("人员："+b((null==(e=a.staff)?void 0:e.name)||"服务人员"),1)]})),_:2},1024),n(s,{class:"staff-subtitle"},{default:m((()=>[p("日期："+b(a.schedule_date||"未指定日期"),1)])),_:2},1024)])),_:2},1024)]})),_:2},1024),n(o,{class:"group-total"},{default:m((()=>[n(s,{class:"group-total-label"},{default:m((()=>[p("小计")])),_:1}),n(s,{class:"group-total-value",style:y({color:d(z).ctaColor})},{default:m((()=>[p(" ¥"+b(T(a.total_price)),1)])),_:2},1032,["style"])])),_:2},1024)])),_:2},1024),n(o,{class:"group-packages"},{default:m((()=>[(u(!0),i(f,null,g(a.packages,(a=>(u(),_(o,{class:"package-group",key:a.key},{default:m((()=>[n(o,{class:"package-header"},{default:m((()=>[n(o,{class:"package-title"},{default:m((()=>[n(h,{name:"gift",size:"24"}),n(s,null,{default:m((()=>{var e;return[p("套餐："+b((null==(e=a.package)?void 0:e.name)||"服务套餐"),1)]})),_:2},1024)])),_:2},1024),n(s,{class:"package-total",style:y({color:d(z).ctaColor})},{default:m((()=>[p(" ¥"+b(T(a.total_price)),1)])),_:2},1032,["style"])])),_:2},1024),n(o,{class:"package-items"},{default:m((()=>[(u(!0),i(f,null,g(a.items,(a=>(u(),_(o,{class:"package-item",key:a.id},{default:m((()=>[n(o,{class:"slot-info"},{default:m((()=>[n(o,{class:"slot-row"},{default:m((()=>[n(s,{class:"slot-label"},{default:m((()=>[p("场次："+b(B(a)),1)])),_:2},1024),n(s,{class:"slot-price",style:y({color:d(z).ctaColor})},{default:m((()=>[p(" ¥"+b(T(a.price)),1)])),_:2},1032,["style"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:1})):v("v-if",!0),d(P)?(u(),_(o,{key:1,class:"section"},{default:m((()=>[n(o,{class:"section-title"},{default:m((()=>[p("费用明细")])),_:1}),n(o,{class:"price-row"},{default:m((()=>[n(s,null,{default:m((()=>[p("商品金额")])),_:1}),n(s,null,{default:m((()=>[p("¥"+b(T(H.value.total_amount)),1)])),_:1})])),_:1}),H.value.coupon_amount>0?(u(),_(o,{key:0,class:"price-row"},{default:m((()=>[n(s,null,{default:m((()=>[p("优惠金额")])),_:1}),n(s,{class:"text-discount"},{default:m((()=>[p("-¥"+b(T(H.value.coupon_amount)),1)])),_:1})])),_:1})):v("v-if",!0),n(o,{class:"price-row total"},{default:m((()=>[n(s,null,{default:m((()=>[p("应付金额")])),_:1}),n(s,{class:"text-total"},{default:m((()=>[p("¥"+b(T(H.value.pay_amount)),1)])),_:1})])),_:1})])),_:1})):v("v-if",!0)])),_:1})),n(o,{class:"submit-bar"},{default:m((()=>[n(o,{class:"submit-price"},{default:m((()=>[n(s,{class:"label"},{default:m((()=>[p("合计")])),_:1}),n(s,{class:"symbol",style:y({color:d(z).ctaColor})},{default:m((()=>[p("¥")])),_:1},8,["style"]),n(s,{class:"value",style:y({color:d(z).ctaColor})},{default:m((()=>[p(b(T(H.value.pay_amount)),1)])),_:1},8,["style"])])),_:1}),n(o,{class:k(["submit-btn",{disabled:!d(R)}]),style:y(d(R)?{background:`linear-gradient(135deg, ${d(z).primaryColor} 0%, ${d(z).primaryColor} 100%)`}:{}),onClick:L},{default:m((()=>[n(s,null,{default:m((()=>[p(b(G.value?"提交中...":"提交订单"),1)])),_:1})])),_:1},8,["class","style"])])),_:1})])),_:1})],64)}}}),[["__scopeId","data-v-27b9ca25"]]);export{A as default};
